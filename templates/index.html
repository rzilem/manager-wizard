<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager Wizard | PS Property Management</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            /* LinkedIn-inspired Blue */
            --primary: #0A66C2;
            --primary-dark: #004182;
            --primary-light: #E8F3FF;
            --primary-glow: rgba(10, 102, 194, 0.15);

            /* Status Colors */
            --success: #057642;
            --success-light: #D4EDDA;
            --warning: #915907;
            --warning-light: #FFF3CD;
            --danger: #CC1016;
            --danger-light: #F8D7DA;

            /* Neutrals - LinkedIn style */
            --gray-50: #F9FAFB;
            --gray-100: #F3F2EF;
            --gray-200: #E8E6DF;
            --gray-300: #D0CEC7;
            --gray-400: #9CA3AF;
            --gray-500: #666666;
            --gray-600: #444444;
            --gray-700: #333333;
            --gray-800: #191919;
            --gray-900: #000000;

            /* Shadows */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.08), 0 2px 4px -1px rgba(0, 0, 0, 0.04);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);

            /* Spacing */
            --radius: 8px;
            --radius-sm: 6px;
            --radius-lg: 12px;
            --radius-full: 9999px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            min-height: 100vh;
            background: var(--gray-100);
            color: var(--gray-800);
            line-height: 1.5;
        }

        /* Header */
        .header {
            background: white;
            padding: 0.75rem 2rem;
            border-bottom: 1px solid var(--gray-200);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
        }

        .logo-text {
            display: flex;
            flex-direction: column;
        }

        .logo-title {
            font-weight: 700;
            font-size: 1.125rem;
            color: var(--gray-900);
        }

        .logo-subtitle {
            font-size: 0.7rem;
            color: var(--gray-500);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--success-light);
            border-radius: var(--radius-full);
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--success);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
        }

        .status-dot.disconnected {
            background: var(--danger);
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Hero Section */
        .hero {
            text-align: center;
            padding: 1.5rem 1rem 1rem;
        }

        .hero h1 {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        .hero p {
            font-size: 0.95rem;
            color: var(--gray-500);
            max-width: 650px;
            margin: 0 auto;
            line-height: 1.5;
        }

        /* Search Container */
        .search-container {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
        }

        /* Search Mode Toggle */
        .search-mode-toggle {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin-bottom: 1.25rem;
        }

        .mode-btn {
            padding: 8px 16px;
            border: 1px solid var(--gray-200);
            background: white;
            border-radius: var(--radius-full);
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--gray-600);
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .mode-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .mode-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Search Box */
        .search-box {
            position: relative;
            margin-bottom: 1rem;
        }

        .search-input {
            width: 100%;
            padding: 1rem 1rem 1rem 3rem;
            font-size: 1rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            transition: all 0.15s ease;
            font-family: inherit;
            background: white;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-glow);
        }

        .search-input::placeholder {
            color: var(--gray-400);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
            font-size: 1rem;
        }

        .search-btn {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.625rem 1.25rem;
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            font-family: inherit;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .search-btn:hover {
            background: var(--primary-dark);
        }

        .search-btn:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
        }

        /* Search Hints */
        .search-hints {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
        }

        .hint-chip {
            padding: 4px 12px;
            background: var(--gray-100);
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            color: var(--gray-600);
            cursor: pointer;
            transition: all 0.15s ease;
            border: 1px solid transparent;
        }

        .hint-chip:hover {
            background: var(--primary-light);
            color: var(--primary);
            border-color: var(--primary);
        }

        .hint-chip i {
            margin-right: 4px;
            opacity: 0.7;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-top: 1.25rem;
            padding-top: 1.25rem;
            border-top: 1px solid var(--gray-200);
        }

        .quick-action-btn {
            padding: 8px 14px;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-full);
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--gray-600);
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .quick-action-btn:hover {
            background: var(--primary-light);
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Results Container */
        .results-container {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            min-height: 200px;
        }

        /* Results Header */
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .results-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detected-badge {
            padding: 4px 10px;
            background: var(--primary-light);
            color: var(--primary);
            border-radius: var(--radius-full);
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        /* Results Grid */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            gap: 1rem;
        }

        /* AI Answer Card - REFINED STYLE */
        .ai-answer-card {
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
            border: 1px solid #a7d8c4;
            border-left: 4px solid #10b981;
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.12), 0 1px 3px rgba(0,0,0,0.08);
        }

        .ai-answer-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 1.25rem;
        }

        .ai-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .ai-answer-title {
            font-weight: 700;
            font-size: 0.9rem;
            color: #059669;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .ai-answer-subtitle {
            font-size: 0.85rem;
            color: #6b7280;
        }

        /* The main answer - BIG and BOLD */
        .ai-main-answer {
            font-size: 1.75rem;
            font-weight: 700;
            color: #1f2937;
            line-height: 1.3;
            margin-bottom: 1rem;
        }

        /* Source Document Section */
        .ai-source-section {
            margin-top: 1.5rem;
            padding-top: 1.25rem;
            border-top: 1px solid #d1d5db;
        }

        .ai-source-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
        }

        .ai-source-doc {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 1rem 1.25rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-left: 3px solid var(--primary);
            border-radius: var(--radius);
            flex-wrap: wrap;
        }

        .ai-source-doc > i {
            font-size: 1.5rem;
            color: #ef4444;
        }

        .ai-source-doc > span {
            flex: 1;
            font-size: 1rem;
            font-weight: 600;
            color: #374151;
            min-width: 150px;
        }

        .ai-source-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border-radius: var(--radius);
            font-size: 0.9rem;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.15s ease;
        }

        .ai-source-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(10, 102, 194, 0.25);
        }

        /* Beautiful Quote Box - Clean & Readable */
        .quote-box {
            margin-top: 1.5rem;
            background: white;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            position: relative;
            border: 1px solid #e5e7eb;
            border-left: 4px solid #64748b;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .quote-icon {
            position: absolute;
            top: -10px;
            left: 20px;
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(100,116,139,0.3);
        }

        .quote-content {
            font-size: 1rem;
            line-height: 1.7;
            color: #374151;
            font-style: normal;
            margin-bottom: 1rem;
            padding-top: 0.5rem;
        }

        .quote-content mark {
            background: linear-gradient(120deg, #fef08a 0%, #fde047 100%);
            color: #1f2937;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
            box-decoration-break: clone;
            -webkit-box-decoration-break: clone;
        }

        .quote-source {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
            flex-wrap: wrap;
        }

        .quote-source > i {
            font-size: 1.25rem;
            color: #ef4444;
        }

        .quote-source > span {
            flex: 1;
            font-size: 0.95rem;
            font-weight: 500;
            color: #4b5563;
            min-width: 120px;
        }

        .quote-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: var(--primary);
            color: white;
            border-radius: var(--radius);
            font-size: 0.85rem;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.15s ease;
        }

        .quote-link:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(10, 102, 194, 0.25);
        }

        .ai-answer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
            background: white;
            border: 1px solid #e5e7eb;
            padding: 1rem;
            border-radius: var(--radius);
        }

        .ai-data-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .ai-data-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .ai-data-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1f2937;
        }

        .ai-summary {
            font-size: 0.95rem;
            color: #4b5563;
            line-height: 1.6;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }

        .ai-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 0.75rem;
        }

        .ai-tag {
            padding: 4px 10px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            color: #4b5563;
            font-weight: 500;
        }

        /* Collapsible Documents Section */
        .documents-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: var(--gray-100);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            cursor: pointer;
            margin-bottom: 1rem;
            transition: all 0.15s ease;
        }

        .documents-toggle:hover {
            background: var(--gray-200);
        }

        .documents-toggle-text {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--gray-600);
        }

        .documents-toggle-icon {
            transition: transform 0.2s ease;
        }

        .documents-toggle.expanded .documents-toggle-icon {
            transform: rotate(180deg);
        }

        .documents-collapsible {
            display: none;
        }

        .documents-collapsible.expanded {
            display: block;
        }

        /* Homeowner Card */
        .homeowner-card {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            padding: 1.25rem;
            transition: all 0.15s ease;
            border-left: 4px solid var(--primary);
        }

        .homeowner-card.status-owed {
            border-left-color: var(--danger);
        }

        .homeowner-card.status-credit {
            border-left-color: var(--success);
        }

        .homeowner-card.status-collections {
            border-left-color: #7C2D12;
        }

        .homeowner-card.status-attorney {
            border: 2px solid var(--danger);
            background: var(--danger-light);
            border-left-width: 4px;
        }

        .homeowner-card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
            position: relative;
        }

        .copy-card-btn {
            background: transparent;
            border: 1px solid var(--gray-300);
            color: var(--gray-600);
            cursor: pointer;
            padding: 6px 12px;
            font-size: 0.8rem;
            border-radius: var(--radius-md);
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .copy-card-btn:hover {
            background: var(--gray-100);
            border-color: var(--primary);
            color: var(--primary);
        }

        .copy-email-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border: none;
            color: white;
            cursor: pointer;
            padding: 8px 16px;
            font-size: 0.85rem;
            font-weight: 500;
            border-radius: var(--radius-md);
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }

        .copy-email-btn:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4);
        }

        .copy-email-btn.copied {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .copy-email-btn i {
            font-size: 0.9rem;
        }

        .card-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        .card-community {
            font-size: 0.8rem;
            color: var(--gray-500);
            margin-top: 2px;
        }

        .card-balance {
            text-align: right;
        }

        .balance-amount {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .balance-amount.balance-owed,
        .balance-amount.balance-high,
        .balance-amount.balance-medium,
        .balance-amount.balance-low { color: var(--danger); }
        .balance-amount.balance-credit { color: var(--success); }
        .balance-amount.balance-current { color: var(--gray-400); }

        .balance-label {
            font-size: 0.65rem;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: var(--radius-full);
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-top: 4px;
        }

        .badge-attorney { background: var(--danger); color: white; }
        .badge-collections { background: #7C2D12; color: white; }
        .badge-60days { background: var(--danger); color: white; }
        .badge-30days { background: var(--warning); color: white; }
        .badge-board-member { background: #7c3aed; color: white; }

        /* ============================================
           ACCOUNT LEDGER STYLES
           ============================================ */
        .ledger-section {
            margin-top: 1rem;
            border-top: 1px solid var(--gray-200);
            padding-top: 1rem;
        }

        .ledger-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            color: var(--gray-700);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            width: 100%;
            justify-content: center;
            font-family: inherit;
        }

        .ledger-toggle:hover {
            background: var(--gray-100);
            border-color: var(--gray-300);
        }

        .ledger-toggle.active {
            background: var(--primary-light);
            border-color: var(--primary);
            color: var(--primary);
        }

        .ledger-toggle i {
            transition: transform 0.2s;
        }

        .ledger-toggle.active i.fa-chevron-down {
            transform: rotate(180deg);
        }

        .ledger-container {
            display: none;
            margin-top: 1rem;
            overflow: hidden;
            animation: slideDown 0.3s ease-out;
        }

        .ledger-container.show {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
            }
            to {
                opacity: 1;
                max-height: 1000px;
            }
        }

        .ledger-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .ledger-title {
            font-weight: 600;
            color: var(--gray-800);
            font-size: 0.95rem;
        }

        .ledger-subtitle {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .ledger-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }

        .ledger-table thead {
            background: var(--gray-100);
        }

        .ledger-table th {
            padding: 0.5rem 0.75rem;
            text-align: left;
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 2px solid var(--gray-200);
        }

        .ledger-table th:nth-child(2),
        .ledger-table th:nth-child(3),
        .ledger-table th:nth-child(4) {
            text-align: right;
        }

        .ledger-table td {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid var(--gray-100);
            color: var(--gray-700);
        }

        .ledger-table td:nth-child(2),
        .ledger-table td:nth-child(3),
        .ledger-table td:nth-child(4) {
            text-align: right;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
        }

        .ledger-table tbody tr:hover {
            background: var(--gray-50);
        }

        .ledger-table tbody tr:last-child td {
            border-bottom: none;
        }

        .ledger-date {
            white-space: nowrap;
        }

        .ledger-amount {
            font-weight: 500;
        }

        .ledger-amount.charge {
            color: var(--danger);
        }

        .ledger-amount.payment {
            color: var(--success);
        }

        .ledger-balance {
            font-weight: 600;
            color: var(--gray-800);
        }

        .ledger-loading {
            padding: 2rem;
            text-align: center;
            color: var(--gray-500);
        }

        .ledger-loading i {
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        .ledger-empty {
            padding: 1.5rem;
            text-align: center;
            color: var(--gray-500);
            font-size: 0.875rem;
        }

        .ledger-error {
            padding: 1rem;
            text-align: center;
            color: var(--danger);
            background: var(--danger-light);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
        }

        .card-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 0.75rem;
        }

        .tag-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: var(--gray-100);
            border-radius: var(--radius-full);
            font-size: 0.7rem;
            color: var(--gray-600);
        }

        .tag-badge.tenant {
            background: #DBEAFE;
            color: #1E40AF;
        }

        .tag-badge.collections-provider {
            background: var(--danger-light);
            color: #7C2D12;
        }

        .card-financial {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 0.75rem;
            padding: 0.75rem;
            background: var(--gray-50);
            border-radius: var(--radius-sm);
        }

        .financial-item {
            text-align: center;
        }

        .financial-value {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--gray-800);
        }

        .financial-value.positive { color: var(--success); }
        .financial-value.negative { color: var(--danger); }

        .financial-label {
            font-size: 0.6rem;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .card-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .detail-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .detail-icon {
            width: 28px;
            height: 28px;
            background: var(--gray-100);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-500);
            flex-shrink: 0;
            font-size: 0.75rem;
        }

        .detail-content {
            flex: 1;
            min-width: 0;
        }

        .detail-label {
            font-size: 0.6rem;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .detail-value {
            font-size: 0.8rem;
            color: var(--gray-800);
            word-break: break-word;
        }

        .detail-value a {
            color: var(--primary);
            text-decoration: none;
        }

        .detail-value a:hover {
            text-decoration: underline;
        }

        .card-actions {
            display: flex;
            gap: 0.5rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--gray-200);
        }

        .btn {
            padding: 8px 14px;
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-family: inherit;
            border: none;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background: var(--gray-200);
        }

        /* Document Card */
        .document-card {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            padding: 1.25rem;
            transition: all 0.15s ease;
            border-left: 4px solid var(--doc-color, var(--primary));
        }

        .document-card:hover {
            box-shadow: var(--shadow-md);
        }

        .doc-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 0.75rem;
        }

        .doc-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: white;
            flex-shrink: 0;
            background: var(--doc-color, var(--primary));
        }

        .doc-title-section {
            flex: 1;
            min-width: 0;
        }

        .doc-type-label {
            font-size: 0.65rem;
            font-weight: 600;
            color: var(--doc-color, var(--primary));
            text-transform: uppercase;
            letter-spacing: 0.03em;
            margin-bottom: 2px;
        }

        .doc-title {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--gray-900);
            line-height: 1.3;
        }

        .doc-community {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: var(--gray-100);
            border-radius: var(--radius-full);
            font-size: 0.7rem;
            color: var(--gray-600);
            margin-top: 6px;
        }

        .doc-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-bottom: 0.75rem;
        }

        .doc-meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .doc-actions {
            display: flex;
            gap: 0.5rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--gray-200);
        }

        /* Attorney Warning */
        .attorney-warning {
            background: var(--danger);
            color: white;
            padding: 0.875rem;
            border-radius: var(--radius-sm);
            margin-bottom: 0.75rem;
        }

        .attorney-warning-title {
            font-weight: 700;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
        }

        .attorney-warning-text {
            font-size: 0.75rem;
            opacity: 0.95;
            line-height: 1.4;
        }

        .attorney-contact {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        .attorney-name {
            font-weight: 600;
            font-size: 0.8rem;
        }

        /* Loading States */
        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem 2rem;
            color: var(--gray-500);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--gray-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--gray-500);
        }

        .empty-state-icon {
            width: 64px;
            height: 64px;
            background: var(--gray-100);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.5rem;
            color: var(--gray-400);
        }

        .empty-state h3 {
            font-size: 1.1rem;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        /* Results Sections */
        .results-section {
            margin-bottom: 1.5rem;
        }

        .results-section:last-child {
            margin-bottom: 0;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--gray-100);
        }

        .section-icon {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: white;
            background: var(--primary);
        }

        .section-icon.document { background: #0078D4; }

        .section-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--gray-800);
        }

        .section-count {
            padding: 2px 8px;
            background: var(--gray-100);
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gray-600);
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 1.5rem;
            color: var(--gray-500);
            font-size: 0.8rem;
        }

        .footer a {
            color: var(--primary);
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        /* User Menu */
        .user-menu {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-name {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--gray-700);
        }

        .logout-link {
            color: var(--gray-400);
            font-size: 0.9rem;
            transition: color 0.15s ease;
            padding: 4px;
        }

        .logout-link:hover {
            color: var(--danger);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .hero { padding: 1rem 1rem 0.75rem; }
            .hero h1 { font-size: 1.75rem; }
            .hero p { font-size: 0.875rem; }
            .search-container, .results-container { padding: 1rem; }
            .search-mode-toggle { flex-wrap: wrap; }
            .mode-btn { flex: 1; justify-content: center; min-width: 80px; }
            .results-grid { grid-template-columns: 1fr; }
            .card-header { flex-direction: column; gap: 0.5rem; }
            .card-balance { text-align: left; }
            .card-details { grid-template-columns: 1fr; }
            .card-financial { grid-template-columns: 1fr; }
            .search-btn span { display: none; }
            .search-hints { display: none; }
            .user-name { display: none; }
            .user-menu { gap: 4px; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo">
                <div class="logo-icon">
                    <i class="fas fa-wand-magic-sparkles"></i>
                </div>
                <div class="logo-text">
                    <span class="logo-title">Manager Wizard</span>
                    <span class="logo-subtitle">PS Property Management</span>
                </div>
            </a>
            <div style="display: flex; align-items: center; gap: 16px;">
                <div class="status-indicator" id="statusIndicator">
                    <span class="status-dot"></span>
                    <span id="statusText">Connected</span>
                </div>
                {% if user %}
                <div class="user-menu">
                    <div class="user-avatar" title="{{ user.name }}">
                        {{ user.first_name[0] if user.first_name else user.name[0] }}{{ user.last_name[0] if user.last_name else '' }}
                    </div>
                    <div class="user-info">
                        <span class="user-name">{{ user.first_name or user.name }}</span>
                        <a href="{{ url_for('logout') }}" class="logout-link" title="Sign out">
                            <i class="fas fa-sign-out-alt"></i>
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Hero -->
        <section class="hero">
            <h1>Ask me anything</h1>
            <p>Find homeowners by phone, address, or name â€” or ask about community rules, CC&Rs, and policies.</p>
        </section>

        <!-- Search Container -->
        <div class="search-container">
            <!-- Mode Toggle -->
            <div class="search-mode-toggle">
                <button class="mode-btn active" data-mode="auto">
                    <i class="fas fa-wand-magic-sparkles"></i>
                    <span>Auto-detect</span>
                </button>
                <button class="mode-btn" data-mode="homeowner">
                    <i class="fas fa-user"></i>
                    <span>Homeowners</span>
                </button>
                <button class="mode-btn" data-mode="document">
                    <i class="fas fa-file-alt"></i>
                    <span>Documents</span>
                </button>
                <button class="mode-btn" data-mode="both">
                    <i class="fas fa-layer-group"></i>
                    <span>Both</span>
                </button>
            </div>

            <!-- Search Box -->
            <div class="search-box">
                <input type="text"
                       class="search-input"
                       id="searchInput"
                       placeholder="Search by phone, address, name, or ask a question..."
                       autocomplete="off">
                <i class="fas fa-search search-icon"></i>
                <button class="search-btn" id="searchBtn">
                    <i class="fas fa-arrow-right"></i>
                    <span>Search</span>
                </button>
            </div>

            <!-- Search Hints -->
            <div class="search-hints">
                <span class="hint-chip" data-query="512-555-1234"><i class="fas fa-phone"></i>Phone</span>
                <span class="hint-chip" data-query="7016 Walkup Lane"><i class="fas fa-map-marker-alt"></i>Address</span>
                <span class="hint-chip" data-query="fence height Falcon Pointe"><i class="fas fa-border-all"></i>Fence Rules</span>
                <span class="hint-chip" data-query="pool rules Vista Vera"><i class="fas fa-swimming-pool"></i>Pool Rules</span>
                <span class="hint-chip" data-query="parking policy"><i class="fas fa-car"></i>Parking</span>
                <span class="hint-chip" data-query="pet restrictions"><i class="fas fa-paw"></i>Pets</span>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <button class="quick-action-btn" data-community="Falcon Pointe">
                    <i class="fas fa-building"></i> Falcon Pointe
                </button>
                <button class="quick-action-btn" data-community="Avalon">
                    <i class="fas fa-building"></i> Avalon
                </button>
                <button class="quick-action-btn" data-community="Chandler Creek">
                    <i class="fas fa-building"></i> Chandler Creek
                </button>
                <button class="quick-action-btn" data-community="Heritage Park">
                    <i class="fas fa-building"></i> Heritage Park
                </button>
                <button class="quick-action-btn" data-community="Vista Vera">
                    <i class="fas fa-building"></i> Vista Vera
                </button>
            </div>
        </div>

        <!-- Results Container -->
        <div class="results-container" id="resultsContainer" style="display: none;">
            <div id="resultsContent"></div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>PS Property Management &bull; Serving Central Texas communities since 1987 &bull; <a href="tel:512-251-6122">512-251-6122</a></p>
    </footer>

    <script>
        // State
        let currentMode = 'auto';
        let isSearching = false;

        // Elements
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const resultsContainer = document.getElementById('resultsContainer');
        const resultsContent = document.getElementById('resultsContent');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkStatus();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentMode = btn.dataset.mode;
                    updatePlaceholder();
                });
            });

            searchBtn.addEventListener('click', performSearch);
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') performSearch();
            });

            document.querySelectorAll('.hint-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    searchInput.value = chip.dataset.query;
                    performSearch();
                });
            });

            document.querySelectorAll('.quick-action-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    searchInput.value = btn.dataset.community;
                    currentMode = 'homeowner';
                    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                    document.querySelector('.mode-btn[data-mode="homeowner"]').classList.add('active');
                    performSearch();
                });
            });
        }

        function updatePlaceholder() {
            const placeholders = {
                'auto': 'Search by phone, address, name, or ask a question...',
                'homeowner': 'Search homeowners by phone, address, or name...',
                'document': 'Ask about community rules and policies...',
                'both': 'Search everything...'
            };
            searchInput.placeholder = placeholders[currentMode] || placeholders['auto'];
        }

        async function checkStatus() {
            try {
                const resp = await fetch('/api/status');
                const data = await resp.json();

                if (data.status === 'connected') {
                    statusIndicator.querySelector('.status-dot').classList.remove('disconnected');
                    statusText.textContent = `Connected`;
                } else {
                    statusIndicator.querySelector('.status-dot').classList.add('disconnected');
                    statusText.textContent = 'Disconnected';
                }
            } catch (error) {
                statusIndicator.querySelector('.status-dot').classList.add('disconnected');
                statusText.textContent = 'Connection error';
            }
        }

        async function performSearch() {
            const query = searchInput.value.trim();
            if (!query || isSearching) return;

            isSearching = true;
            searchBtn.disabled = true;
            resultsContainer.style.display = 'block';

            resultsContent.innerHTML = `
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <p>Searching...</p>
                </div>
            `;

            try {
                const resp = await fetch(`/api/unified-search?q=${encodeURIComponent(query)}&mode=${currentMode}`);
                const data = await resp.json();

                if (data.error) {
                    showError(data.error);
                    return;
                }

                renderResults(data);
            } catch (error) {
                showError('Search failed. Please try again.');
                console.error('Search error:', error);
            } finally {
                isSearching = false;
                searchBtn.disabled = false;
            }
        }

        function showError(message) {
            resultsContent.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3>Oops!</h3>
                    <p>${escapeHtml(message)}</p>
                </div>
            `;
        }

        function renderResults(data) {
            const hasHomeowners = data.homeowners && data.homeowners.length > 0;
            const hasDocuments = data.documents && data.documents.length > 0;
            const hasAiAnswer = data.ai_answer && data.ai_answer.extracted;

            if (!hasHomeowners && !hasDocuments) {
                resultsContent.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <h3>No results found</h3>
                        <p>Try a different search term or adjust your search mode.</p>
                    </div>
                `;
                return;
            }

            let html = '';

            html += `
                <div class="results-header">
                    <div class="results-title">
                        Results for "${escapeHtml(data.query)}"
                    </div>
                    <span class="detected-badge">
                        ${data.detected_type === 'homeowner' ? 'Homeowner Search' :
                          data.detected_type === 'document' ? 'Document Search' : 'Combined Search'}
                    </span>
                </div>
            `;

            if (hasAiAnswer) {
                html += renderAiAnswerCard(data.ai_answer, data.community_detected, data.documents, data.query);
            }

            if (hasHomeowners) {
                html += `
                    <div class="results-section">
                        <div class="section-header">
                            <div class="section-icon">
                                <i class="fas fa-user"></i>
                            </div>
                            <span class="section-title">Homeowners</span>
                            <span class="section-count">${data.homeowners.length}</span>
                        </div>
                        <div class="results-grid">
                            ${data.homeowners.map(h => renderHomeownerCard(h)).join('')}
                        </div>
                    </div>
                `;
            }

            if (hasDocuments && !hasAiAnswer) {
                // Only show documents list if there's NO AI answer
                html += `
                    <div class="results-section">
                        <div class="section-header">
                            <div class="section-icon document">
                                <i class="fas fa-file-alt"></i>
                            </div>
                            <span class="section-title">Documents</span>
                            <span class="section-count">${data.documents.length}</span>
                        </div>
                        <div class="results-grid">
                            ${data.documents.map(d => renderDocumentCard(d)).join('')}
                        </div>
                    </div>
                `;
            }

            resultsContent.innerHTML = html;
        }

        function toggleDocuments(element) {
            element.classList.toggle('expanded');
            const collapsible = element.nextElementSibling;
            collapsible.classList.toggle('expanded');
        }

        function renderAiAnswerCard(aiAnswer, community, documents, query) {
            const extracted = aiAnswer.extracted;
            const type = aiAnswer.extraction_type;

            // Check if we have a real answer or just "not found"
            const answerLower = (extracted.answer || '').toLowerCase();
            const hasNoAnswer = !extracted.answer ||
                answerLower.includes('not found') ||
                answerLower.includes('no specific') ||
                answerLower.includes('could not find') ||
                answerLower.includes('no pool') ||
                answerLower.includes('no pet') ||
                answerLower.includes('no parking') ||
                answerLower.includes('no fence') ||
                answerLower.includes('not available') ||
                answerLower.includes('unable to find') ||
                answerLower.includes('unable to determine') ||
                answerLower.includes('cannot determine') ||
                answerLower.includes('no information') ||
                answerLower.includes('no mention') ||
                answerLower.includes('does not mention') ||
                answerLower.includes('does not address') ||
                answerLower.includes('does not contain') ||
                answerLower.startsWith('no ') ||
                answerLower.includes('additional documents') ||
                answerLower.includes('more specific search');

            if (hasNoAnswer) {
                return `
                    <div class="ai-answer-card" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-color: #fbbf24; border-left-color: #f59e0b;">
                        <div class="ai-answer-header">
                            <div class="ai-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                                <i class="fas fa-search"></i>
                            </div>
                            <div>
                                <div class="ai-answer-title" style="color: #b45309;">No Specific Answer Found</div>
                                <div class="ai-answer-subtitle">${community ? `For ${escapeHtml(community)}` : 'In available documents'}</div>
                            </div>
                        </div>
                        <div class="ai-main-answer" style="font-size: 1.25rem;">${escapeHtml(extracted.answer || 'Could not find specific information in the indexed documents.')}</div>
                        <div class="ai-summary">Try a different search term, or the information may not be in the indexed documents yet.</div>
                    </div>
                `;
            }

            // We have an answer! Show it prominently
            const mainAnswer = extracted.answer || extracted.summary || '';
            const sourceName = extracted.source || (extracted.documents_found && extracted.documents_found[0]) || '';

            // Find the source document URL from the documents array
            let sourceUrl = '';
            if (sourceName && documents) {
                const sourceDoc = documents.find(d =>
                    d.title && d.title.toLowerCase().includes(sourceName.toLowerCase().replace('.pdf', ''))
                );
                if (sourceDoc && sourceDoc.url) {
                    sourceUrl = sourceDoc.url;
                }
            }

            // Get caption with highlights from first document if available
            let captionHighlighted = '';
            if (documents && documents.length > 0 && documents[0].caption_highlighted) {
                captionHighlighted = documents[0].caption_highlighted;
            }

            // Generate unique ID for this answer card
            const answerId = 'answer-' + Math.random().toString(36).substr(2, 9);
            const quoteText = extracted.quote || (captionHighlighted ? captionHighlighted.replace(/<[^>]*>/g, '') : '');

            return `
                <div class="ai-answer-card" id="${answerId}">
                    <div class="ai-answer-header">
                        <div class="ai-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div>
                            <div class="ai-answer-title">Answer Found</div>
                            <div class="ai-answer-subtitle">${community ? `For ${escapeHtml(community)}` : 'From community documents'}</div>
                        </div>
                    </div>
                    <div class="ai-main-answer">${escapeHtml(mainAnswer)}</div>
                    ${extracted.quote || captionHighlighted ? `
                        <div class="quote-box">
                            <div class="quote-icon"><i class="fas fa-quote-left"></i></div>
                            <div class="quote-content">
                                ${captionHighlighted ? captionHighlighted : escapeHtml(extracted.quote)}
                            </div>
                            ${sourceName ? `
                                <div class="quote-source">
                                    <i class="fas fa-file-pdf"></i>
                                    <span>${escapeHtml(sourceName)}</span>
                                    ${sourceUrl ? `
                                        <a href="${escapeHtml(sourceUrl)}" target="_blank" class="quote-link">
                                            Open Document <i class="fas fa-external-link-alt"></i>
                                        </a>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                    ` : (sourceName ? `
                        <div class="ai-source-section">
                            <div class="ai-source-label">Source Document</div>
                            <div class="ai-source-doc">
                                <i class="fas fa-file-pdf"></i>
                                <span>${escapeHtml(sourceName)}</span>
                                ${sourceUrl ? `
                                    <a href="${escapeHtml(sourceUrl)}" target="_blank" class="ai-source-btn">
                                        <i class="fas fa-external-link-alt"></i>
                                        View in SharePoint
                                    </a>
                                ` : ''}
                            </div>
                        </div>
                    ` : '')}
                    <div class="ai-answer-actions" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                        <button class="copy-email-btn"
                            data-card-id="${answerId}"
                            data-query="${escapeHtml(query || '')}"
                            onclick="copyAnswerAsImage(this)"
                            title="Copy as image for email">
                            <i class="fas fa-image"></i> Copy for Email
                        </button>
                    </div>
                </div>
            `;
        }

        function renderHomeownerCard(h) {
            const isAttorney = h.collection_status && h.collection_status.toLowerCase().includes('attorney');

            let cardClass = 'homeowner-card';
            if (isAttorney) {
                cardClass += ' status-attorney';
            } else if (h.collection_indicator === 'collections') {
                cardClass += ' status-collections';
            } else if (h.balance_status === 'owed') {
                cardClass += ' status-owed';
            } else if (h.balance_status === 'credit') {
                cardClass += ' status-credit';
            }

            // Board member badge (shows alongside other badges)
            let boardMemberBadge = '';
            if (h.is_board_member) {
                boardMemberBadge = '<span class="status-badge badge-board-member"><i class="fas fa-star"></i> BOARD MEMBER</span>';
            }

            let statusBadge = '';
            if (isAttorney) {
                statusBadge = '<span class="status-badge badge-attorney">ATTORNEY</span>';
            } else if (h.collection_indicator === 'collections') {
                statusBadge = '<span class="status-badge badge-collections">In Collections</span>';
            } else if (h.collection_indicator === '60_days') {
                statusBadge = '<span class="status-badge badge-60days">60+ Days</span>';
            } else if (h.collection_indicator === '30_days') {
                statusBadge = '<span class="status-badge badge-30days">30+ Days</span>';
            }

            let balanceClass = 'balance-current';
            if (h.balance > 1000) balanceClass = 'balance-high';
            else if (h.balance > 500) balanceClass = 'balance-medium';
            else if (h.balance > 0) balanceClass = 'balance-low';
            else if (h.balance_status === 'credit') balanceClass = 'balance-credit';

            let tagsHtml = '';
            if (h.tenant_name || h.collection_provider || h.unit_lot) {
                tagsHtml = '<div class="card-tags">';
                if (h.tenant_name) {
                    tagsHtml += `<span class="tag-badge tenant"><i class="fas fa-user-friends"></i> Tenant: ${escapeHtml(h.tenant_name)}</span>`;
                }
                if (h.collection_provider) {
                    tagsHtml += `<span class="tag-badge collections-provider"><i class="fas fa-gavel"></i> ${escapeHtml(h.collection_provider)}</span>`;
                }
                if (h.unit_lot) {
                    tagsHtml += `<span class="tag-badge"><i class="fas fa-door-open"></i> ${escapeHtml(h.unit_lot)}</span>`;
                }
                tagsHtml += '</div>';
            }

            let financialHtml = '';
            if (h.last_payment && !isAttorney) {
                financialHtml = `
                    <div class="card-financial">
                        <div class="financial-item">
                            <div class="financial-value ${h.balance > 0 ? 'negative' : (h.balance_status === 'credit' ? 'positive' : '')}">${escapeHtml(h.balance_display)}</div>
                            <div class="financial-label">Balance</div>
                        </div>
                        <div class="financial-item">
                            <div class="financial-value positive">${escapeHtml(h.last_payment.amount)}</div>
                            <div class="financial-label">Last Payment</div>
                        </div>
                        <div class="financial-item">
                            <div class="financial-value">${escapeHtml(h.last_payment.date)}</div>
                            <div class="financial-label">Payment Date</div>
                        </div>
                    </div>
                `;
            }

            let attorneyWarningHtml = '';
            if (isAttorney) {
                attorneyWarningHtml = `
                    <div class="attorney-warning">
                        <div class="attorney-warning-title">
                            <i class="fas fa-exclamation-triangle"></i>
                            ACCOUNT WITH ATTORNEY
                        </div>
                        <div class="attorney-warning-text">
                            This account has been referred to an attorney for collections.<br>
                            <strong>Do NOT discuss balance or payment details with the homeowner.</strong>
                        </div>
                        ${h.collection_provider ? `
                            <div class="attorney-contact">
                                <div class="attorney-name">${escapeHtml(h.collection_provider)}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            const balanceHeaderHtml = isAttorney ? '' : `
                <div class="card-balance">
                    <div class="balance-amount ${balanceClass}">${escapeHtml(h.balance_display)}</div>
                    <div class="balance-label">${h.balance_status === 'credit' ? 'Credit Balance' : 'Balance'}</div>
                </div>
            `;

            // Generate unique ID for this card
            const cardId = 'homeowner-' + Math.random().toString(36).substr(2, 9);

            return `
                <div class="${cardClass}" id="${cardId}">
                    <div class="card-header">
                        <div>
                            <div class="card-name">${escapeHtml(h.owner_name)}</div>
                            <div class="card-community">${escapeHtml(h.community)}</div>
                            ${boardMemberBadge}${statusBadge}
                        </div>
                        ${balanceHeaderHtml}
                    </div>
                    ${attorneyWarningHtml}
                    ${tagsHtml}
                    ${financialHtml}
                    <div class="card-details">
                        <div class="detail-item">
                            <div class="detail-icon"><i class="fas fa-map-marker-alt"></i></div>
                            <div class="detail-content">
                                <div class="detail-label">Address</div>
                                <div class="detail-value">${escapeHtml(h.property_address)}</div>
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-icon"><i class="fas fa-phone"></i></div>
                            <div class="detail-content">
                                <div class="detail-label">Phone</div>
                                <div class="detail-value">
                                    ${h.phone !== 'N/A' ? `<a href="tel:${h.phone}">${escapeHtml(h.phone)}</a>` : 'N/A'}
                                </div>
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-icon"><i class="fas fa-envelope"></i></div>
                            <div class="detail-content">
                                <div class="detail-label">Email</div>
                                <div class="detail-value">
                                    ${h.email !== 'N/A' ? `<a href="mailto:${h.email}">${escapeHtml(h.email)}</a>` : 'N/A'}
                                </div>
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-icon"><i class="fas fa-hashtag"></i></div>
                            <div class="detail-content">
                                <div class="detail-label">Account</div>
                                <div class="detail-value">${escapeHtml(h.account_number)}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Account Ledger Section -->
                    ${!isAttorney ? `
                    <div class="ledger-section">
                        <button class="ledger-toggle" data-account="${escapeHtml(h.account_number)}" onclick="toggleLedger(this)">
                            <i class="fas fa-receipt"></i>
                            <span>View Account Ledger</span>
                            <i class="fas fa-chevron-down toggle-icon"></i>
                        </button>
                        <div class="ledger-container" id="ledger-${escapeHtml(h.account_number).replace(/[^a-zA-Z0-9]/g, '')}">
                            <!-- Ledger content loads here -->
                        </div>
                    </div>
                    ` : ''}

                    <div class="card-actions">
                        ${h.vantaca_url ? `
                            <a href="${escapeHtml(h.vantaca_url)}" target="_blank" class="btn btn-primary">
                                <i class="fas fa-external-link-alt"></i> Open in Vantaca
                            </a>
                        ` : ''}
                        <button class="copy-email-btn"
                            data-name="${escapeHtml(h.owner_name)}"
                            data-community="${escapeHtml(h.community)}"
                            data-address="${escapeHtml(h.property_address)}"
                            data-phone="${escapeHtml(h.phone)}"
                            data-email="${escapeHtml(h.email)}"
                            data-account="${escapeHtml(h.account_number)}"
                            data-balance="${escapeHtml(h.balance_display)}"
                            data-balance-status="${escapeHtml(h.balance_status || '')}"
                            onclick="copyHomeownerForEmail(this)"
                            title="Copy formatted info for email">
                            <i class="fas fa-envelope"></i> Copy for Email
                        </button>
                    </div>
                </div>
            `;
        }

        function renderDocumentCard(doc) {
            const typeInfo = doc.doc_type_info || { icon: 'file-alt', color: '#0078d4', label: 'Document' };

            return `
                <div class="document-card" style="--doc-color: ${typeInfo.color}">
                    <div class="doc-header">
                        <div class="doc-icon" style="background: ${typeInfo.color}">
                            <i class="fas fa-${typeInfo.icon}"></i>
                        </div>
                        <div class="doc-title-section">
                            <div class="doc-type-label">${escapeHtml(typeInfo.label)}</div>
                            <div class="doc-title">${escapeHtml(doc.title)}</div>
                            ${doc.community ? `
                                <div class="doc-community">
                                    <i class="fas fa-building"></i>
                                    ${escapeHtml(doc.community)}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="doc-meta">
                        <div class="doc-meta-item">
                            <i class="fas fa-star"></i>
                            ${doc.score ? doc.score.toFixed(2) : 'N/A'} relevance
                        </div>
                    </div>
                    <div class="doc-actions">
                        ${doc.url ? `
                            <a href="${escapeHtml(doc.url)}" target="_blank" class="btn btn-primary">
                                <i class="fas fa-external-link-alt"></i> View in SharePoint
                            </a>
                        ` : ''}
                        <button class="btn btn-secondary" onclick="copyToClipboard('${escapeHtml(doc.title)}')">
                            <i class="fas fa-copy"></i> Copy Title
                        </button>
                    </div>
                </div>
            `;
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                console.log('Copied:', text);
            });
        }

        // ========================================
        // Account Ledger Functions
        // ========================================
        const ledgerCache = {};

        function toggleLedger(btn) {
            const account = btn.dataset.account;
            const containerId = 'ledger-' + account.replace(/[^a-zA-Z0-9]/g, '');
            const container = document.getElementById(containerId);
            const icon = btn.querySelector('.toggle-icon');

            if (container.classList.contains('open')) {
                container.classList.remove('open');
                icon.style.transform = 'rotate(0deg)';
            } else {
                container.classList.add('open');
                icon.style.transform = 'rotate(180deg)';

                // Load ledger data if not already loaded
                if (!ledgerCache[account]) {
                    loadLedger(account, container);
                }
            }
        }

        async function loadLedger(account, container) {
            container.innerHTML = '<div class="ledger-loading"><i class="fas fa-spinner fa-spin"></i> Loading ledger...</div>';

            try {
                const response = await fetch(`/api/history?account=${encodeURIComponent(account)}&limit=15`);
                const data = await response.json();

                if (data.error) {
                    container.innerHTML = `<div class="ledger-error"><i class="fas fa-exclamation-triangle"></i> ${data.error}</div>`;
                    return;
                }

                if (!data.history || data.history.length === 0) {
                    container.innerHTML = '<div class="ledger-empty"><i class="fas fa-info-circle"></i> No recent transactions found</div>';
                    return;
                }

                ledgerCache[account] = data.history;
                renderLedgerTable(data.history, container);

            } catch (err) {
                container.innerHTML = `<div class="ledger-error"><i class="fas fa-exclamation-triangle"></i> Failed to load ledger</div>`;
                console.error('Ledger load error:', err);
            }
        }

        function renderLedgerTable(history, container) {
            let html = `
                <table class="ledger-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th class="amount">Charge</th>
                            <th class="amount">Payment</th>
                            <th class="amount">Balance</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // History should already be sorted with most recent first from the API
            history.forEach(item => {
                const date = item.date || 'N/A';
                const desc = item.description || 'N/A';
                const charge = item.charge ? formatCurrency(item.charge) : '-';
                const payment = item.payment ? formatCurrency(item.payment) : '-';
                const balance = item.running_balance !== null ? formatCurrency(item.running_balance) : '-';

                const balanceClass = item.running_balance < 0 ? 'credit' : (item.running_balance > 0 ? 'debit' : '');

                html += `
                    <tr>
                        <td class="date">${escapeHtml(date)}</td>
                        <td class="description">${escapeHtml(desc)}</td>
                        <td class="amount charge">${charge !== '-' ? charge : '<span class="dash">-</span>'}</td>
                        <td class="amount payment">${payment !== '-' ? payment : '<span class="dash">-</span>'}</td>
                        <td class="amount balance ${balanceClass}">${balance}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        function formatCurrency(value) {
            if (value === null || value === undefined) return '-';
            const num = parseFloat(value);
            if (isNaN(num)) return '-';
            return '$' + Math.abs(num).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        // Copy homeowner info as formatted HTML for emails
        function copyHomeownerForEmail(btn) {
            const data = {
                name: btn.dataset.name || 'N/A',
                community: btn.dataset.community || 'N/A',
                address: btn.dataset.address || 'N/A',
                phone: btn.dataset.phone || 'N/A',
                email: btn.dataset.email || 'N/A',
                account: btn.dataset.account || 'N/A',
                balance: btn.dataset.balance || 'N/A',
                balance_status: btn.dataset.balanceStatus || ''
            };
            const balanceColor = data.balance_status === 'credit' ? '#059669' :
                                 (parseFloat(data.balance?.replace(/[$,]/g, '')) > 500 ? '#dc2626' : '#ea580c');

            const html = `
<table style="border-collapse: collapse; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 8px; border: 1px solid #e2e8f0; width: 100%; max-width: 400px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
    <tr>
        <td style="padding: 16px; border-bottom: 1px solid #e2e8f0;">
            <div style="font-size: 16px; font-weight: 700; color: #1e293b; margin-bottom: 4px;">${data.name || 'N/A'}</div>
            <div style="font-size: 13px; color: #64748b;">${data.community || 'N/A'}</div>
        </td>
        <td style="padding: 16px; border-bottom: 1px solid #e2e8f0; text-align: right;">
            <div style="font-size: 18px; font-weight: 700; color: ${balanceColor};">${data.balance || 'N/A'}</div>
            <div style="font-size: 11px; color: #94a3b8; text-transform: uppercase;">${data.balance_status === 'credit' ? 'Credit' : 'Balance'}</div>
        </td>
    </tr>
    <tr>
        <td colspan="2" style="padding: 12px 16px;">
            <table style="width: 100%; border-collapse: collapse;">
                <tr>
                    <td style="padding: 6px 0; color: #64748b; font-size: 12px; width: 70px;">Address</td>
                    <td style="padding: 6px 0; color: #1e293b; font-size: 13px;">${data.address || 'N/A'}</td>
                </tr>
                <tr>
                    <td style="padding: 6px 0; color: #64748b; font-size: 12px;">Phone</td>
                    <td style="padding: 6px 0; color: #1e293b; font-size: 13px;">${data.phone || 'N/A'}</td>
                </tr>
                <tr>
                    <td style="padding: 6px 0; color: #64748b; font-size: 12px;">Email</td>
                    <td style="padding: 6px 0; color: #1e293b; font-size: 13px;">${data.email || 'N/A'}</td>
                </tr>
                <tr>
                    <td style="padding: 6px 0; color: #64748b; font-size: 12px;">Account</td>
                    <td style="padding: 6px 0; color: #1e293b; font-size: 13px;">${data.account || 'N/A'}</td>
                </tr>
            </table>
        </td>
    </tr>
</table>`;

            copyHtmlToClipboard(html, btn);
        }

        // Copy AI answer card as image for emails
        async function copyAnswerAsImage(btn) {
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Capturing...';

            try {
                const cardId = btn.dataset.cardId;
                const query = btn.dataset.query || '';
                const card = document.getElementById(cardId);

                if (!card) {
                    throw new Error('Card not found');
                }

                // Create a wrapper with the question above the card
                const wrapper = document.createElement('div');
                wrapper.style.cssText = 'position: fixed; left: -9999px; top: 0; background: #ffffff; padding: 24px; max-width: 700px; font-family: Inter, -apple-system, BlinkMacSystemFont, sans-serif;';

                // Add the question at the top (larger text as requested)
                if (query) {
                    const questionDiv = document.createElement('div');
                    questionDiv.style.cssText = 'font-size: 20px; font-weight: 500; color: #1e293b; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid #e5e7eb;';
                    questionDiv.textContent = '"' + query + '"';
                    wrapper.appendChild(questionDiv);
                }

                // Clone the card (without the copy button and header)
                const cardClone = card.cloneNode(true);
                // Remove the actions div from the clone
                const actionsDiv = cardClone.querySelector('.ai-answer-actions');
                if (actionsDiv) {
                    actionsDiv.remove();
                }
                // Remove the "Answer Found" header from the clone
                const headerDiv = cardClone.querySelector('.ai-answer-header');
                if (headerDiv) {
                    headerDiv.remove();
                }
                wrapper.appendChild(cardClone);

                document.body.appendChild(wrapper);

                // Capture as canvas
                const canvas = await html2canvas(wrapper, {
                    backgroundColor: '#ffffff',
                    scale: 2, // Higher resolution
                    logging: false,
                    useCORS: true
                });

                document.body.removeChild(wrapper);

                // Convert to blob and copy
                canvas.toBlob(async (blob) => {
                    try {
                        await navigator.clipboard.write([
                            new ClipboardItem({ 'image/png': blob })
                        ]);
                        btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                        btn.classList.add('copied');
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                            btn.classList.remove('copied');
                        }, 2000);
                    } catch (clipErr) {
                        console.error('Clipboard write failed:', clipErr);
                        // Fallback: download the image
                        const link = document.createElement('a');
                        link.download = 'answer.png';
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                        btn.innerHTML = '<i class="fas fa-download"></i> Downloaded';
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                        }, 2000);
                    }
                }, 'image/png');

            } catch (err) {
                console.error('Image capture error:', err);
                btn.innerHTML = '<i class="fas fa-times"></i> Failed';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                }, 2000);
            }
        }

        // Copy AI answer as formatted HTML for emails (legacy fallback)
        function copyAnswerForEmail(btn) {
            const data = {
                community: btn.dataset.community || 'Community Documents',
                answer: btn.dataset.answer || '',
                quote: btn.dataset.quote || '',
                source: btn.dataset.source || ''
            };

            // Build quote section if we have a quote
            let quoteHtml = '';
            if (data.quote) {
                quoteHtml = `
                <tr>
                    <td style="padding: 16px 20px;">
                        <table cellpadding="0" cellspacing="0" border="0" width="100%" style="background-color: #ffffff; border-radius: 8px; border: 1px solid #e5e7eb; border-left: 4px solid #64748b;">
                            <tr>
                                <td width="40" valign="top" style="padding: 16px 0 16px 16px;">
                                    <div style="width: 32px; height: 32px; background-color: #64748b; border-radius: 16px; text-align: center; line-height: 32px;">
                                        <span style="color: white; font-size: 18px; font-weight: bold;">"</span>
                                    </div>
                                </td>
                                <td valign="top" style="padding: 16px 16px 16px 12px; font-size: 14px; color: #475569; line-height: 1.6;">${data.quote}</td>
                            </tr>
                            ${data.source ? `
                            <tr>
                                <td colspan="2" style="padding: 0 16px 12px 16px;">
                                    <div style="font-size: 12px; color: #94a3b8;">
                                        <span style="color: #ef4444;">ðŸ“„</span> ${data.source}
                                    </div>
                                </td>
                            </tr>
                            ` : ''}
                        </table>
                    </td>
                </tr>`;
            } else if (data.source) {
                // Source without quote
                quoteHtml = `
                <tr>
                    <td style="padding: 0 20px 16px 20px;">
                        <div style="font-size: 12px; color: #94a3b8;">
                            <span style="color: #ef4444;">ðŸ“„</span> Source: ${data.source}
                        </div>
                    </td>
                </tr>`;
            }

            const html = `<table cellpadding="0" cellspacing="0" border="0" width="100%" style="max-width: 550px; font-family: Arial, Helvetica, sans-serif;">
    <tr>
        <td>
            <table cellpadding="0" cellspacing="0" border="0" width="100%" style="background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%); background-color: #f0fdf4; border-radius: 12px; border: 1px solid #a7d8c4; border-left: 5px solid #10b981; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);">
                <tr>
                    <td style="padding: 20px 20px 12px 20px;">
                        <div style="font-size: 20px; font-weight: 700; color: #1e293b; line-height: 1.4;">${data.answer}</div>
                    </td>
                </tr>
                ${quoteHtml}
            </table>
        </td>
    </tr>
</table>`;

            copyHtmlToClipboard(html, btn);
        }

        // Helper to copy HTML to clipboard with fallback
        function copyHtmlToClipboard(html, btn) {
            const originalText = btn.innerHTML;

            // Show copying state
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Copying...';

            try {
                // Try to copy as HTML (for rich paste in Outlook/Gmail)
                const htmlBlob = new Blob([html], { type: 'text/html' });
                const textBlob = new Blob([html.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim()], { type: 'text/plain' });

                navigator.clipboard.write([
                    new ClipboardItem({
                        'text/html': htmlBlob,
                        'text/plain': textBlob
                    })
                ]).then(() => {
                    btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                    btn.classList.add('copied');
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.classList.remove('copied');
                    }, 2000);
                }).catch(err => {
                    console.error('Clipboard write failed:', err);
                    // Fallback - try execCommand
                    fallbackCopy(html, btn, originalText);
                });
            } catch (err) {
                console.error('Clipboard API error:', err);
                fallbackCopy(html, btn, originalText);
            }
        }

        // Fallback copy using execCommand
        function fallbackCopy(html, btn, originalText) {
            const container = document.createElement('div');
            container.innerHTML = html;
            container.style.position = 'fixed';
            container.style.left = '-9999px';
            document.body.appendChild(container);

            const range = document.createRange();
            range.selectNodeContents(container);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);

            try {
                document.execCommand('copy');
                btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                btn.classList.add('copied');
            } catch (err) {
                console.error('execCommand failed:', err);
                btn.innerHTML = '<i class="fas fa-times"></i> Failed';
            }

            selection.removeAllRanges();
            document.body.removeChild(container);

            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.remove('copied');
            }, 2000);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>

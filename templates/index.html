<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager Wizard | PS Property Management</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        if (window.pdfjsLib) {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
    </script>
    <style>
        :root {
            /* LinkedIn-inspired Blue */
            --primary: #0A66C2;
            --primary-dark: #004182;
            --primary-light: #E8F3FF;
            --primary-glow: rgba(10, 102, 194, 0.15);

            /* Status Colors */
            --success: #057642;
            --success-light: #D4EDDA;
            --warning: #915907;
            --warning-light: #FFF3CD;
            --danger: #CC1016;
            --danger-light: #F8D7DA;

            /* Neutrals - LinkedIn style */
            --gray-50: #F9FAFB;
            --gray-100: #F3F2EF;
            --gray-200: #E8E6DF;
            --gray-300: #D0CEC7;
            --gray-400: #9CA3AF;
            --gray-500: #666666;
            --gray-600: #444444;
            --gray-700: #333333;
            --gray-800: #191919;
            --gray-900: #000000;

            /* Shadows */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.08), 0 2px 4px -1px rgba(0, 0, 0, 0.04);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);

            /* Spacing */
            --radius: 8px;
            --radius-sm: 6px;
            --radius-lg: 12px;
            --radius-full: 9999px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            min-height: 100vh;
            background: var(--gray-100);
            color: var(--gray-800);
            line-height: 1.5;
        }

        /* Header */
        .header {
            background: white;
            padding: 0.75rem 2rem;
            border-bottom: 1px solid var(--gray-200);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow: hidden;
            position: relative;
        }
        /* Level 2: Wizard Revealed (10 searches) - icon becomes wizard image */
        .logo-icon.wizard-revealed {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #7c3aed, #4f46e5);
            box-shadow: 0 0 12px rgba(124, 58, 237, 0.4);
        }
        .logo-icon.wizard-revealed i { display: none; }
        .logo-icon.wizard-revealed .logo-wizard-img {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        /* Level 4: Archmage (30 searches) - bigger with aura */
        .logo-icon.archmage-level {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6, #6d28d9);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.6), 0 0 40px rgba(139, 92, 246, 0.2);
        }
        .logo-icon.archmage-level i { display: none; }
        .logo-icon.archmage-level .logo-wizard-img {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        /* Level 5: Grand Wizard (50 searches) - golden glow + pulse */
        .logo-icon.grand-wizard-level {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            box-shadow: 0 0 25px rgba(245, 158, 11, 0.6), 0 0 50px rgba(245, 158, 11, 0.2);
            animation: logoGrandPulse 3s ease-in-out infinite;
        }
        .logo-icon.grand-wizard-level i { display: none; }
        .logo-icon.grand-wizard-level .logo-wizard-img {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        @keyframes logoGrandPulse {
            0%, 100% { box-shadow: 0 0 25px rgba(245, 158, 11, 0.6), 0 0 50px rgba(245, 158, 11, 0.2); }
            50% { box-shadow: 0 0 35px rgba(245, 158, 11, 0.8), 0 0 70px rgba(245, 158, 11, 0.3); }
        }
        .logo-wizard-img { display: none; }

        .logo-text {
            display: flex;
            flex-direction: column;
        }

        .logo-title {
            font-weight: 700;
            font-size: 1.125rem;
            color: var(--gray-900);
        }

        .logo-subtitle {
            font-size: 0.7rem;
            color: var(--gray-500);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--success-light);
            border-radius: var(--radius-full);
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--success);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
        }

        .status-dot.disconnected {
            background: var(--danger);
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Hero Section */
        .hero {
            text-align: center;
            padding: 0.75rem 1rem 0.5rem;
        }

        .hero h1 {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        .hero p {
            font-size: 0.95rem;
            color: var(--gray-500);
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.5;
            white-space: nowrap;
        }

        /* Search Container */
        .search-container {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
        }

        /* Search Mode Toggle */
        .search-mode-toggle {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin-bottom: 1.25rem;
        }

        .mode-btn {
            padding: 8px 16px;
            border: 1px solid var(--gray-200);
            background: white;
            border-radius: var(--radius-full);
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--gray-600);
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .mode-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .mode-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Search Box */
        .search-box {
            position: relative;
            margin-bottom: 1rem;
        }

        .search-input {
            width: 100%;
            padding: 1rem 1rem 1rem 3rem;
            font-size: 1rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            transition: all 0.15s ease;
            font-family: inherit;
            background: white;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-glow);
        }

        .search-input::placeholder {
            color: var(--gray-400);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
            font-size: 1rem;
        }

        .search-btn {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.625rem 1.25rem;
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            font-family: inherit;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .search-btn:hover {
            background: var(--primary-dark);
        }

        .search-btn:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
        }

        /* Autocomplete Dropdown */
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--gray-300);
            border-top: none;
            border-radius: 0 0 var(--radius) var(--radius);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }

        .autocomplete-dropdown.show {
            display: block;
        }

        .autocomplete-item {
            padding: 0.75rem 1rem 0.75rem 3rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid var(--gray-100);
            transition: background 0.1s ease;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background: var(--primary-light);
        }

        .autocomplete-item i {
            color: var(--primary);
            font-size: 0.875rem;
        }

        .autocomplete-name {
            font-weight: 500;
            color: var(--gray-800);
        }

        .autocomplete-code {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-left: auto;
        }

        .autocomplete-header {
            padding: 0.5rem 1rem;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--gray-500);
            background: var(--gray-50);
            font-weight: 600;
        }

        /* Did You Mean Suggestions */
        .did-you-mean {
            background: var(--primary-light);
            border: 1px solid rgba(10, 102, 194, 0.15);
            border-radius: var(--radius);
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .did-you-mean-icon {
            color: var(--primary);
            font-size: 1.25rem;
        }

        .did-you-mean-text {
            color: var(--gray-700);
            font-size: 0.9rem;
        }

        .did-you-mean-suggestion {
            background: white;
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 0.375rem 0.75rem;
            border-radius: var(--radius-full);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .did-you-mean-suggestion:hover {
            background: var(--primary);
            color: white;
        }

        /* Search Hints */
        .search-hints {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
        }

        .hint-chip {
            padding: 4px 12px;
            background: var(--gray-100);
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            color: var(--gray-600);
            cursor: pointer;
            transition: all 0.15s ease;
            border: 1px solid transparent;
        }

        .hint-chip:hover {
            background: var(--primary-light);
            color: var(--primary);
            border-color: var(--primary);
        }

        .hint-chip i {
            margin-right: 4px;
            opacity: 0.7;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-top: 1.25rem;
            padding-top: 1.25rem;
            border-top: 1px solid var(--gray-200);
        }

        .quick-action-btn {
            padding: 8px 14px;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-full);
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--gray-600);
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .quick-action-btn:hover {
            background: var(--primary-light);
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Results Container */
        .results-container {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            min-height: 200px;
        }

        /* Results Header */
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .results-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detected-badge {
            padding: 4px 10px;
            background: var(--primary-light);
            color: var(--primary);
            border-radius: var(--radius-full);
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        /* Results Grid - Full width single column */
        .results-grid {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* AI Answer Card - REFINED STYLE */
        .ai-answer-card {
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
            border: 1px solid #a7d8c4;
            border-left: 4px solid #10b981;
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.12), 0 1px 3px rgba(0,0,0,0.08);
        }

        .ai-answer-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 1.25rem;
        }

        .ai-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .ai-answer-title {
            font-weight: 700;
            font-size: 0.9rem;
            color: #059669;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .ai-answer-subtitle {
            font-size: 0.85rem;
            color: #6b7280;
        }

        /* The main answer - BIG and BOLD */
        .ai-main-answer {
            font-size: 1.75rem;
            font-weight: 700;
            color: #1f2937;
            line-height: 1.3;
            margin-bottom: 1rem;
        }

        /* Source Document Section */
        .ai-source-section {
            margin-top: 1.5rem;
            padding-top: 1.25rem;
            border-top: 1px solid #d1d5db;
        }

        .ai-source-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
        }

        .ai-source-doc {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 1rem 1.25rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-left: 3px solid var(--primary);
            border-radius: var(--radius);
            flex-wrap: wrap;
        }

        .ai-source-doc > i {
            font-size: 1.5rem;
            color: #ef4444;
        }

        .ai-source-doc > span {
            flex: 1;
            font-size: 1rem;
            font-weight: 600;
            color: #374151;
            min-width: 150px;
        }

        .ai-source-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border-radius: var(--radius);
            font-size: 0.9rem;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.15s ease;
        }

        .ai-source-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(10, 102, 194, 0.25);
        }

        /* Beautiful Quote Box - Clean & Readable */
        .quote-box {
            margin-top: 1.5rem;
            background: white;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            position: relative;
            border: 1px solid #e5e7eb;
            border-left: 4px solid #64748b;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .quote-icon {
            position: absolute;
            top: -10px;
            left: 20px;
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(100,116,139,0.3);
        }

        .quote-content {
            font-size: 1rem;
            line-height: 1.7;
            color: #374151;
            font-style: normal;
            margin-bottom: 1rem;
            padding-top: 0.5rem;
        }

        .quote-content mark {
            background: linear-gradient(120deg, #fef08a 0%, #fde047 100%);
            color: #1f2937;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
            box-decoration-break: clone;
            -webkit-box-decoration-break: clone;
        }

        .quote-source {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
            flex-wrap: wrap;
        }

        .quote-source > i {
            font-size: 1.25rem;
            color: #ef4444;
        }

        .quote-source > span {
            flex: 1;
            font-size: 0.95rem;
            font-weight: 500;
            color: #4b5563;
            min-width: 120px;
        }

        .quote-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: var(--primary);
            color: white;
            border-radius: var(--radius);
            font-size: 0.85rem;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.15s ease;
        }

        .quote-link:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(10, 102, 194, 0.25);
        }

        .btn-view-source {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .btn-view-source:hover {
            background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.35);
        }

        .btn-view-source.active {
            background: linear-gradient(135deg, #4338ca 0%, #3730a3 100%);
        }

        .ai-source-panel {
            margin-top: 1rem;
        }

        .ai-answer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
            background: white;
            border: 1px solid #e5e7eb;
            padding: 1rem;
            border-radius: var(--radius);
        }

        .ai-data-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .ai-data-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .ai-data-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1f2937;
        }

        .ai-summary {
            font-size: 0.95rem;
            color: #4b5563;
            line-height: 1.6;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }

        .ai-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 0.75rem;
        }

        .ai-tag {
            padding: 4px 10px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            color: #4b5563;
            font-weight: 500;
        }

        /* Collapsible Documents Section */
        .documents-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: var(--gray-100);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            cursor: pointer;
            margin-bottom: 1rem;
            transition: all 0.15s ease;
        }

        .documents-toggle:hover {
            background: var(--gray-200);
        }

        .documents-toggle-text {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--gray-600);
        }

        .documents-toggle-icon {
            transition: transform 0.2s ease;
        }

        .documents-toggle.expanded .documents-toggle-icon {
            transform: rotate(180deg);
        }

        .documents-collapsible {
            display: none;
        }

        .documents-collapsible.expanded {
            display: block;
        }

        /* Homeowner Card */
        .homeowner-card {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            padding: 1.25rem;
            transition: all 0.15s ease;
            border-left: 4px solid var(--primary);
        }

        .homeowner-card.status-owed {
            border-left-color: var(--danger);
        }

        .homeowner-card.status-credit {
            border-left-color: var(--success);
        }

        .homeowner-card.status-collections {
            border-left-color: #7C2D12;
        }

        .homeowner-card.status-attorney {
            border: 2px solid var(--danger);
            background: var(--danger-light);
            border-left-width: 4px;
        }

        .homeowner-card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
            position: relative;
        }

        .copy-card-btn {
            background: transparent;
            border: 1px solid var(--gray-300);
            color: var(--gray-600);
            cursor: pointer;
            padding: 6px 12px;
            font-size: 0.8rem;
            border-radius: var(--radius-md);
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .copy-card-btn:hover {
            background: var(--gray-100);
            border-color: var(--primary);
            color: var(--primary);
        }

        .copy-email-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border: none;
            color: white;
            cursor: pointer;
            padding: 8px 16px;
            font-size: 0.85rem;
            font-weight: 500;
            border-radius: var(--radius-md);
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }

        .copy-email-btn:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4);
        }

        .copy-email-btn.copied {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .copy-email-btn i {
            font-size: 0.9rem;
        }

        .card-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        .card-community {
            font-size: 0.8rem;
            color: var(--gray-500);
            margin-top: 2px;
        }

        .card-balance {
            text-align: right;
        }

        .balance-amount {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .balance-amount.balance-owed,
        .balance-amount.balance-high,
        .balance-amount.balance-medium,
        .balance-amount.balance-low { color: var(--danger); }
        .balance-amount.balance-credit { color: var(--success); }
        .balance-amount.balance-current { color: var(--gray-400); }

        .balance-label {
            font-size: 0.65rem;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: var(--radius-full);
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-top: 4px;
        }

        .badge-attorney { background: var(--danger); color: white; }
        .badge-collections { background: #7C2D12; color: white; }
        .badge-60days { background: var(--danger); color: white; }
        .badge-30days { background: var(--warning); color: white; }
        .badge-board-member { background: #7c3aed; color: white; }
        .badge-new-owner { background: #0891b2; color: white; }
        .badge-tenant { background: #6366f1; color: white; }
        .badge-payment-plan { background: #f59e0b; color: white; }
        .badge-longtime-owner { background: #059669; color: white; }

        /* ============================================
           ACCOUNT LEDGER STYLES
           ============================================ */
        .ledger-section {
            margin-top: 1rem;
            border-top: 1px solid var(--gray-200);
            padding-top: 1rem;
        }

        .ledger-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            color: var(--gray-700);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            width: 100%;
            justify-content: center;
            font-family: inherit;
        }

        .ledger-toggle:hover {
            background: var(--gray-100);
            border-color: var(--gray-300);
        }

        .ledger-toggle.active {
            background: var(--primary-light);
            border-color: var(--primary);
            color: var(--primary);
        }

        .ledger-toggle i {
            transition: transform 0.2s;
        }

        .ledger-toggle.active i.fa-chevron-down {
            transform: rotate(180deg);
        }

        .ledger-container {
            display: none;
            margin-top: 1rem;
            overflow: hidden;
            animation: slideDown 0.3s ease-out;
        }

        .ledger-container.show {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
            }
            to {
                opacity: 1;
                max-height: 1000px;
            }
        }

        .ledger-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .ledger-title {
            font-weight: 600;
            color: var(--gray-800);
            font-size: 0.95rem;
        }

        .ledger-subtitle {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .ledger-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            overflow: hidden;
            background: white;
        }

        .ledger-table thead {
            background: linear-gradient(to bottom, var(--gray-100), var(--gray-50));
        }

        .ledger-table th {
            padding: 0.75rem 1rem;
            text-align: left;
            font-weight: 700;
            color: var(--gray-800);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            border-bottom: 2px solid var(--gray-300);
        }

        .ledger-table th:nth-child(2),
        .ledger-table th:nth-child(3),
        .ledger-table th:nth-child(4) {
            text-align: right;
        }

        .ledger-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--gray-100);
            color: var(--gray-700);
            font-weight: 500;
        }

        .ledger-table td:nth-child(2),
        .ledger-table td:nth-child(3),
        .ledger-table td:nth-child(4) {
            text-align: right;
            font-family: 'Inter', -apple-system, sans-serif;
            font-variant-numeric: tabular-nums;
        }

        .ledger-table tbody tr:hover {
            background: var(--primary-light);
        }

        .ledger-table tbody tr:last-child td {
            border-bottom: none;
        }

        .ledger-date {
            white-space: nowrap;
            font-weight: 600;
            color: var(--gray-800);
        }

        .ledger-amount {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .ledger-amount.charge {
            color: var(--danger);
        }

        .ledger-amount.payment {
            color: var(--success);
            font-weight: 700;
        }

        .ledger-balance {
            font-weight: 700;
            color: var(--gray-900);
            font-size: 0.95rem;
        }

        .ledger-loading {
            padding: 2rem;
            text-align: center;
            color: var(--gray-500);
        }

        .ledger-loading i {
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        .ledger-empty {
            padding: 1.5rem;
            text-align: center;
            color: var(--gray-500);
            font-size: 0.875rem;
        }

        .ledger-error {
            padding: 1rem;
            text-align: center;
            color: var(--danger);
            background: var(--danger-light);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
        }

        .card-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 0.75rem;
        }

        .tag-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: var(--gray-100);
            border-radius: var(--radius-full);
            font-size: 0.7rem;
            color: var(--gray-600);
        }

        .tag-badge.tenant {
            background: #DBEAFE;
            color: #1E40AF;
        }

        .tag-badge.collections-provider {
            background: var(--danger-light);
            color: #7C2D12;
        }

        .card-financial {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 0.75rem;
            padding: 0.75rem;
            background: var(--gray-50);
            border-radius: var(--radius-sm);
        }

        .financial-item {
            text-align: center;
        }

        .financial-value {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--gray-800);
        }

        .financial-value.positive { color: var(--success); }
        .financial-value.negative { color: var(--danger); }

        .financial-label {
            font-size: 0.6rem;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .card-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .detail-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .detail-icon {
            width: 28px;
            height: 28px;
            background: var(--gray-100);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-500);
            flex-shrink: 0;
            font-size: 0.75rem;
        }

        .detail-content {
            flex: 1;
            min-width: 0;
        }

        .detail-label {
            font-size: 0.6rem;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .detail-value {
            font-size: 0.8rem;
            color: var(--gray-800);
            word-break: break-word;
        }

        .detail-value a {
            color: var(--primary);
            text-decoration: none;
        }

        .detail-value a:hover {
            text-decoration: underline;
        }

        .card-actions {
            display: flex;
            gap: 0.5rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--gray-200);
        }

        .btn {
            padding: 8px 14px;
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-family: inherit;
            border: none;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background: var(--gray-200);
        }

        /* Document Card */
        .document-card {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            padding: 1.25rem;
            transition: all 0.15s ease;
            border-left: 4px solid var(--doc-color, var(--primary));
        }

        .document-card:hover {
            box-shadow: var(--shadow-md);
        }

        .doc-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 0.75rem;
        }

        .doc-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: white;
            flex-shrink: 0;
            background: var(--doc-color, var(--primary));
        }

        .doc-title-section {
            flex: 1;
            min-width: 0;
        }

        .doc-type-label {
            font-size: 0.65rem;
            font-weight: 600;
            color: var(--doc-color, var(--primary));
            text-transform: uppercase;
            letter-spacing: 0.03em;
            margin-bottom: 2px;
        }

        .doc-title {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--gray-900);
            line-height: 1.3;
        }

        .doc-community {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: var(--gray-100);
            border-radius: var(--radius-full);
            font-size: 0.7rem;
            color: var(--gray-600);
            margin-top: 6px;
        }

        .doc-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-bottom: 0.75rem;
        }

        .doc-meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .doc-actions {
            display: flex;
            gap: 0.5rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--gray-200);
        }

        /* Inline Document Preview */
        .doc-preview-panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                        opacity 0.3s ease,
                        margin 0.3s ease;
            opacity: 0;
            margin-top: 0;
            border-radius: 0 0 var(--radius) var(--radius);
        }

        .doc-preview-panel.open {
            max-height: 800px;
            opacity: 1;
            margin-top: 1rem;
        }

        .doc-preview-inner {
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            overflow: hidden;
            background: var(--gray-50);
        }

        .doc-preview-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 16px;
            background: linear-gradient(135deg, #1e293b, #334155);
            color: white;
            font-size: 0.78rem;
        }

        .doc-preview-toolbar-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .doc-preview-toolbar-left i {
            font-size: 14px;
            opacity: 0.8;
        }

        .doc-preview-toolbar-title {
            font-weight: 600;
            max-width: 400px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .doc-preview-toolbar-actions {
            display: flex;
            gap: 6px;
        }

        .doc-preview-toolbar-actions a,
        .doc-preview-toolbar-actions button {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 12px;
            border-radius: var(--radius-sm);
            font-size: 0.72rem;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.15s ease;
            border: none;
        }

        .doc-preview-toolbar-actions a {
            background: rgba(255,255,255,0.15);
            color: white;
        }

        .doc-preview-toolbar-actions a:hover {
            background: rgba(255,255,255,0.25);
        }

        .doc-preview-toolbar-actions button {
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.7);
        }

        .doc-preview-toolbar-actions button:hover {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        /* removed old excerpt styles - now using doc-preview-content */

        .doc-preview-content {
            padding: 20px 24px;
            background: white;
            max-height: 400px;
            overflow-y: auto;
        }

        .doc-preview-content::-webkit-scrollbar {
            width: 6px;
        }

        .doc-preview-content::-webkit-scrollbar-track {
            background: var(--gray-100);
        }

        .doc-preview-content::-webkit-scrollbar-thumb {
            background: var(--gray-300);
            border-radius: 6px;
        }

        .doc-preview-content::-webkit-scrollbar-thumb:hover {
            background: var(--gray-400);
        }

        .doc-preview-content-text {
            font-size: 0.88rem;
            line-height: 1.85;
            color: var(--gray-700);
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Georgia', 'Times New Roman', serif;
            letter-spacing: 0.01em;
        }

        .doc-preview-content-text mark {
            background: linear-gradient(120deg, #fef08a 0%, #fde047 100%);
            color: var(--gray-900);
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: 600;
            box-shadow: 0 1px 2px rgba(0,0,0,0.06);
        }

        /* PDF Thumbnail Preview */
        .pdf-thumbnail-section {
            padding: 16px 24px;
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
            text-align: center;
        }
        .pdf-thumbnail-wrapper {
            display: inline-block;
            position: relative;
            border: 1px solid var(--gray-200);
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            background: white;
            max-width: 100%;
        }
        .pdf-thumbnail-wrapper canvas {
            display: block;
            max-width: 100%;
            height: auto;
        }
        .pdf-thumbnail-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 40px 20px;
            color: var(--gray-400);
            font-size: 0.82rem;
        }
        .pdf-thumbnail-loading i {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .pdf-thumbnail-error {
            padding: 20px;
            color: var(--gray-400);
            font-size: 0.8rem;
            text-align: center;
        }
        .pdf-thumbnail-label {
            font-size: 0.7rem;
            color: var(--gray-400);
            margin-top: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .doc-preview-body {
            display: flex;
            flex-direction: column;
        }
        .doc-preview-divider {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 24px;
            background: var(--gray-50);
            font-size: 0.7rem;
            color: var(--gray-400);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }
        .doc-preview-divider::before,
        .doc-preview-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--gray-200);
        }

        .doc-preview-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 16px;
            background: var(--gray-50);
            border-top: 1px solid var(--gray-200);
            font-size: 0.72rem;
            color: var(--gray-500);
        }

        .doc-preview-footer a {
            color: var(--doc-color, var(--primary));
            text-decoration: none;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .doc-preview-footer a:hover {
            text-decoration: underline;
        }

        .btn-preview-toggle {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 7px 14px;
            border-radius: var(--radius-sm);
            font-size: 0.78rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            background: linear-gradient(135deg, var(--doc-color, var(--primary)), color-mix(in srgb, var(--doc-color, var(--primary)), #000 15%));
            color: white;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        }

        .btn-preview-toggle:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn-preview-toggle.active {
            background: var(--gray-600);
        }

        .btn-preview-toggle .toggle-chevron {
            transition: transform 0.3s ease;
            font-size: 10px;
        }

        .btn-preview-toggle.active .toggle-chevron {
            transform: rotate(180deg);
        }

        /* Attorney Warning */
        .attorney-warning {
            background: var(--danger);
            color: white;
            padding: 0.875rem;
            border-radius: var(--radius-sm);
            margin-bottom: 0.75rem;
        }

        .attorney-warning-title {
            font-weight: 700;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
        }

        .attorney-warning-text {
            font-size: 0.75rem;
            opacity: 0.95;
            line-height: 1.4;
        }

        .attorney-contact {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        .attorney-name {
            font-weight: 600;
            font-size: 0.8rem;
        }

        /* Loading States */
        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem 2rem;
            color: var(--gray-500);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--gray-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--gray-500);
        }

        .empty-state-icon {
            width: 64px;
            height: 64px;
            background: var(--gray-100);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.5rem;
            color: var(--gray-400);
        }

        .empty-state h3 {
            font-size: 1.1rem;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        /* Results Sections */
        .results-section {
            margin-bottom: 1.5rem;
        }

        .results-section:last-child {
            margin-bottom: 0;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--gray-100);
        }

        .section-icon {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: white;
            background: var(--primary);
        }

        .section-icon.document { background: #0078D4; }

        .section-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--gray-800);
        }

        .section-count {
            padding: 2px 8px;
            background: var(--gray-100);
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gray-600);
        }

        /* User Menu */
        .user-menu {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-name {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--gray-700);
        }

        .logout-link {
            color: var(--gray-400);
            font-size: 0.9rem;
            transition: color 0.15s ease;
            padding: 4px;
        }

        .logout-link:hover {
            color: var(--danger);
        }

        /* ============================================
           GAMIFICATION ANIMATIONS
           ============================================ */
        @keyframes sparkle {
            0%, 100% { opacity: 0; transform: scale(0) rotate(0deg); }
            50% { opacity: 1; transform: scale(1) rotate(180deg); }
        }
        @keyframes wizardFlyIn {
            0% { transform: translateX(200%) rotate(15deg) scale(0.3); opacity: 0; }
            60% { transform: translateX(-10%) rotate(-5deg) scale(1.1); opacity: 1; }
            80% { transform: translateX(3%) rotate(2deg) scale(0.95); }
            100% { transform: translateX(0) rotate(0deg) scale(1); opacity: 1; }
        }
        @keyframes portalOpen {
            0% { transform: scale(0) rotate(-5deg); opacity: 0; }
            40% { transform: scale(1.08) rotate(1deg); opacity: 1; }
            70% { transform: scale(0.97) rotate(-0.5deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        @keyframes floatParticle {
            0% { transform: translateY(0) translateX(0); opacity: 0; }
            10% { opacity: 0.8; }
            90% { opacity: 0.8; }
            100% { transform: translateY(-100vh) translateX(var(--drift-x, 50px)); opacity: 0; }
        }
        @keyframes glowPulse {
            0%, 100% { box-shadow: 0 0 5px rgba(139, 92, 246, 0.3); }
            50% { box-shadow: 0 0 20px rgba(139, 92, 246, 0.6), 0 0 40px rgba(59, 130, 246, 0.3); }
        }
        @keyframes bubbleIn {
            0% { transform: scale(0) translateY(10px); opacity: 0; }
            60% { transform: scale(1.05) translateY(-2px); }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }
        @keyframes badgeReveal {
            0% { transform: scale(0) rotate(-180deg); opacity: 0; }
            70% { transform: scale(1.2) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        @keyframes cosmicFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        @keyframes shimmer {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }
        @keyframes screenShake {
            0%, 100% { transform: translate(0); }
            10% { transform: translate(-8px, -5px); }
            20% { transform: translate(8px, 3px); }
            30% { transform: translate(-6px, 5px); }
            40% { transform: translate(6px, -3px); }
            50% { transform: translate(-4px, 2px); }
            60% { transform: translate(4px, -2px); }
            70% { transform: translate(-2px, 4px); }
            80% { transform: translate(2px, -1px); }
            90% { transform: translate(-1px, 1px); }
        }
        @keyframes goldenFlash {
            0% { opacity: 0; }
            15% { opacity: 0.7; }
            100% { opacity: 0; }
        }
        @keyframes wizardSlideUp {
            0% { transform: translateY(100px) scale(0.8); opacity: 0; }
            60% { transform: translateY(-10px) scale(1.03); opacity: 1; }
            100% { transform: translateY(0) scale(1); opacity: 1; }
        }
        @keyframes titleReveal {
            0% { transform: scale(0.3); opacity: 0; letter-spacing: 0.5em; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); letter-spacing: 0.05em; }
        }
        @keyframes subtitleFade {
            0% { opacity: 0; transform: translateY(15px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        @keyframes xpFill {
            0% { width: var(--xp-from, 0%); }
            100% { width: var(--xp-to, 100%); }
        }
        @keyframes firework {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            50% { opacity: 1; }
            100% { transform: translateY(-200px) scale(0); opacity: 0; }
        }
        @keyframes confettiDrop {
            0% { transform: translateY(-20px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        @keyframes levelUpPulse {
            0% { text-shadow: 0 0 10px rgba(251, 191, 36, 0.5); }
            50% { text-shadow: 0 0 40px rgba(251, 191, 36, 1), 0 0 80px rgba(251, 191, 36, 0.5); }
            100% { text-shadow: 0 0 10px rgba(251, 191, 36, 0.5); }
        }

        /* ============================================
           GAMIFICATION ELEMENTS
           ============================================ */

        /* Sparkle on logo (5 searches) */
        .logo-sparkle .logo-icon {
            animation: glowPulse 2s ease-in-out infinite;
            position: relative;
        }
        .logo-sparkle .logo-icon::after {
            content: '\f005';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: -6px;
            right: -6px;
            font-size: 10px;
            color: #fbbf24;
            animation: sparkle 2s ease-in-out infinite;
        }

        /* Wizard avatar (10+ searches) - LARGER and more prominent */
        .wizard-avatar-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        .wizard-avatar-container.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .wizard-avatar-container img {
            width: 140px;
            height: auto;
            filter: drop-shadow(0 6px 20px rgba(139, 92, 246, 0.5));
            animation: cosmicFloat 3s ease-in-out infinite;
            cursor: pointer;
            transition: transform 0.3s ease, filter 0.3s ease;
        }
        .wizard-avatar-container img:hover {
            transform: scale(1.1);
            filter: drop-shadow(0 8px 30px rgba(139, 92, 246, 0.7));
        }

        /* Speech bubble */
        .wizard-speech-bubble {
            position: absolute;
            bottom: 100%;
            right: 0;
            background: white;
            border-radius: 12px;
            padding: 12px 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            font-size: 0.82rem;
            color: var(--gray-700);
            max-width: 260px;
            line-height: 1.5;
            opacity: 0;
            transform: scale(0);
            pointer-events: none;
            margin-bottom: 10px;
        }
        .wizard-speech-bubble.visible {
            opacity: 1;
            transform: scale(1);
            animation: bubbleIn 0.4s ease-out;
            pointer-events: auto;
        }
        .wizard-speech-bubble::after {
            content: '';
            position: absolute;
            bottom: -8px;
            right: 30px;
            width: 0; height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid white;
        }

        /* Screen effects overlay */
        .screen-flash {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            z-index: 9999; pointer-events: none; opacity: 0;
            background: radial-gradient(circle, rgba(251,191,36,0.6) 0%, rgba(139,92,246,0.3) 50%, transparent 80%);
        }
        .screen-flash.active { animation: goldenFlash 0.8s ease-out forwards; }
        .screen-shake { animation: screenShake 0.5s ease-out; }

        /* Milestone overlay - DRAMATIC */
        .milestone-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.6s ease, background 0.6s ease;
        }
        .milestone-overlay.active {
            opacity: 1;
            pointer-events: auto;
            background: rgba(5, 2, 20, 0.92);
        }
        .milestone-card {
            background: linear-gradient(160deg, #1a0a3e 0%, #0b1628 40%, #1a1145 100%);
            border: 2px solid rgba(251, 191, 36, 0.6);
            border-radius: 24px;
            padding: 0;
            text-align: center;
            width: 90%;
            max-width: 520px;
            animation: portalOpen 0.7s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow:
                0 0 80px rgba(139, 92, 246, 0.5),
                0 0 160px rgba(59, 130, 246, 0.2),
                inset 0 1px 0 rgba(255,255,255,0.1);
            overflow: hidden;
            position: relative;
        }
        .milestone-card::before {
            content: '';
            position: absolute; top: 0; left: 0; right: 0;
            height: 200px;
            background: radial-gradient(ellipse at center top, rgba(139,92,246,0.3) 0%, transparent 70%);
            pointer-events: none;
        }
        .milestone-wizard-img {
            width: 160px;
            height: auto;
            margin: 2rem auto 0;
            display: block;
            animation: wizardSlideUp 0.8s ease-out 0.2s both;
            filter: drop-shadow(0 8px 30px rgba(139, 92, 246, 0.6));
            position: relative;
            z-index: 2;
        }
        .milestone-level-label {
            display: inline-block;
            background: linear-gradient(135deg, rgba(251,191,36,0.2), rgba(251,191,36,0.05));
            border: 1px solid rgba(251,191,36,0.4);
            border-radius: 20px;
            padding: 4px 16px;
            font-size: 0.7rem;
            font-weight: 700;
            color: #fbbf24;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            margin-top: 1rem;
            animation: subtitleFade 0.5s ease-out 0.5s both;
        }
        .milestone-badge-img {
            width: 100px;
            height: auto;
            margin: 0.8rem auto;
            display: block;
            animation: badgeReveal 0.8s ease-out 0.6s both;
            filter: drop-shadow(0 4px 20px rgba(251, 191, 36, 0.5));
        }
        .milestone-title {
            font-size: 2rem;
            font-weight: 900;
            color: #fbbf24;
            margin: 0.3rem 0;
            text-shadow: 0 0 30px rgba(251, 191, 36, 0.5);
            animation: titleReveal 0.7s ease-out 0.8s both;
            letter-spacing: 0.05em;
        }
        .milestone-subtitle {
            font-size: 1rem;
            color: rgba(200, 190, 230, 0.9);
            margin: 0.5rem 2rem 0;
            line-height: 1.6;
            animation: subtitleFade 0.6s ease-out 1.1s both;
        }
        .milestone-xp-section {
            padding: 1.2rem 2rem 0;
            animation: subtitleFade 0.5s ease-out 1.3s both;
        }
        .milestone-xp-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.72rem;
            font-weight: 600;
            color: rgba(200, 190, 230, 0.6);
            margin-bottom: 6px;
        }
        .milestone-xp-bar {
            height: 8px;
            background: rgba(255,255,255,0.08);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        .milestone-xp-fill {
            height: 100%;
            background: linear-gradient(90deg, #8b5cf6, #fbbf24);
            border-radius: 8px;
            animation: xpFill 1.5s ease-out 1.5s both;
            box-shadow: 0 0 12px rgba(251,191,36,0.5);
        }
        .milestone-dismiss {
            margin: 1.5rem auto 2rem;
            padding: 14px 40px;
            background: linear-gradient(135deg, #8b5cf6, #6d28d9);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.25s ease;
            letter-spacing: 0.03em;
            display: inline-block;
            animation: subtitleFade 0.5s ease-out 1.6s both;
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4);
        }
        .milestone-dismiss:hover {
            transform: translateY(-3px) scale(1.03);
            box-shadow: 0 8px 30px rgba(139, 92, 246, 0.6);
        }
        .milestone-confetti {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none; overflow: hidden; z-index: 1;
        }
        .confetti-piece {
            position: absolute;
            width: 8px; height: 8px;
            animation: confettiDrop linear forwards;
        }

        /* Wizard toggle button (header) */
        .wizard-toggle {
            display: none;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            background: linear-gradient(135deg, #8b5cf6, #6d28d9);
            color: white;
            border: none;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s ease;
        }
        .wizard-toggle.unlocked { display: inline-flex; }
        .wizard-toggle:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }
        .wizard-toggle.active {
            background: linear-gradient(135deg, #fbbf24, #d97706);
            color: #1a1145;
        }

        /* Voice mode toggle */
        .voice-toggle {
            display: none;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s ease;
        }
        .voice-toggle.unlocked { display: inline-flex; }
        .voice-toggle:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); }
        .voice-toggle.active { background: linear-gradient(135deg, #fbbf24, #d97706); color: #1a1145; }

        /* Rank display */
        .rank-display {
            display: none;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: var(--radius-full);
            font-size: 0.72rem;
            font-weight: 600;
            color: #8b5cf6;
        }
        .rank-display.visible { display: inline-flex; }

        /* Progress bar (search count) */
        .search-progress {
            display: none;
            height: 3px;
            background: var(--gray-200);
            border-radius: 3px;
            margin-top: 6px;
            overflow: hidden;
        }
        .search-progress.visible { display: block; }
        .search-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #8b5cf6, #6d28d9);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        /* Particles container */
        .particles-container {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 50;
            overflow: hidden;
        }
        .particle {
            position: absolute;
            bottom: -20px;
            border-radius: 50%;
            animation: floatParticle var(--duration, 8s) linear infinite;
            animation-delay: var(--delay, 0s);
        }

        /* Search orb (wizard mode) */
        .search-orb {
            display: none;
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: radial-gradient(circle, #60a5fa 0%, #3b82f6 50%, transparent 70%);
            box-shadow: 0 0 12px rgba(59, 130, 246, 0.6);
            animation: glowPulse 2s ease-in-out infinite;
            z-index: 2;
        }

        /* ============================================
           WIZARD MODE THEME OVERRIDES
           ============================================ */
        body { transition: background 0.8s ease, color 0.5s ease; }
        .header, .search-container, .results-container,
        .homeowner-card, .document-card, .mode-btn,
        .hint-chip, .quick-action-btn, .search-input,
        .search-btn, .logo-icon { transition: all 0.5s ease; }

        body.wizard-mode {
            background: linear-gradient(135deg, #0a0e27 0%, #1a1145 40%, #0d1b3e 100%);
            background-image: url('https://storage.googleapis.com/pspm-community-images/wizard/wizard-bg.png');
            background-size: cover;
            background-attachment: fixed;
            background-blend-mode: overlay;
            color: #e2d9f3;
        }
        body.wizard-mode .header {
            background: rgba(10, 14, 39, 0.95);
            border-bottom-color: rgba(139, 92, 246, 0.3);
            backdrop-filter: blur(10px);
        }
        body.wizard-mode .logo-icon {
            background: linear-gradient(135deg, #8b5cf6, #6d28d9);
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.5);
        }
        body.wizard-mode .logo-title { color: #e2d9f3; text-shadow: 0 0 10px rgba(139,92,246,0.3); }
        body.wizard-mode .logo-subtitle { color: rgba(226,217,243,0.5); }
        body.wizard-mode .hero h1 {
            color: #fbbf24;
            text-shadow: 0 0 20px rgba(251,191,36,0.3);
        }
        body.wizard-mode .hero p { color: rgba(226,217,243,0.7); }
        body.wizard-mode .search-container {
            background: rgba(15, 10, 50, 0.9);
            border-color: rgba(139, 92, 246, 0.3);
            box-shadow: 0 0 20px rgba(59,130,246,0.2), 0 0 60px rgba(139,92,246,0.1);
        }
        body.wizard-mode .search-input {
            background: rgba(10, 14, 39, 0.8);
            border-color: rgba(139, 92, 246, 0.3);
            color: #e2d9f3;
        }
        body.wizard-mode .search-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59,130,246,0.3), 0 0 20px rgba(59,130,246,0.2);
        }
        body.wizard-mode .search-input::placeholder { color: rgba(226,217,243,0.35); }
        body.wizard-mode .search-btn {
            background: linear-gradient(135deg, #8b5cf6, #6d28d9);
            box-shadow: 0 0 15px rgba(139,92,246,0.4);
        }
        body.wizard-mode .search-btn:hover {
            box-shadow: 0 0 25px rgba(139,92,246,0.6);
        }
        body.wizard-mode .search-orb { display: block; }
        body.wizard-mode .search-icon { display: none; }
        body.wizard-mode .mode-btn {
            background: rgba(26, 17, 69, 0.6);
            border-color: rgba(139,92,246,0.3);
            color: #e2d9f3;
        }
        body.wizard-mode .mode-btn.active {
            background: linear-gradient(135deg, #8b5cf6, #6d28d9);
            border-color: #8b5cf6;
            color: white;
        }
        body.wizard-mode .hint-chip {
            background: rgba(26, 17, 69, 0.6);
            color: rgba(226,217,243,0.7);
            border-color: rgba(139,92,246,0.3);
        }
        body.wizard-mode .hint-chip:hover {
            background: rgba(139,92,246,0.2);
            border-color: #8b5cf6;
            color: #fbbf24;
        }
        body.wizard-mode .quick-action-btn {
            background: rgba(26, 17, 69, 0.6);
            border-color: rgba(139,92,246,0.3);
            color: rgba(226,217,243,0.7);
        }
        body.wizard-mode .quick-action-btn:hover {
            background: rgba(139,92,246,0.2);
            border-color: #8b5cf6;
            color: #fbbf24;
        }
        body.wizard-mode .results-container {
            background: rgba(26, 17, 69, 0.85);
            border-color: rgba(139,92,246,0.3);
            box-shadow: 0 0 20px rgba(59,130,246,0.2);
        }
        body.wizard-mode .results-header { border-bottom-color: rgba(139,92,246,0.2); }
        body.wizard-mode .results-title { color: #e2d9f3; }
        body.wizard-mode .section-title { color: #e2d9f3; }
        body.wizard-mode .section-header { border-bottom-color: rgba(139,92,246,0.2); }
        body.wizard-mode .homeowner-card {
            background: rgba(26, 17, 69, 0.7);
            border-color: rgba(139,92,246,0.3);
        }
        body.wizard-mode .homeowner-card:hover {
            box-shadow: 0 0 20px rgba(139,92,246,0.3);
            border-color: rgba(139,92,246,0.5);
        }
        body.wizard-mode .card-name { color: #e2d9f3; }
        body.wizard-mode .card-community { color: rgba(226,217,243,0.5); }
        body.wizard-mode .card-field-label { color: rgba(226,217,243,0.5); }
        body.wizard-mode .card-field-value { color: #e2d9f3; }
        body.wizard-mode .document-card {
            background: rgba(26, 17, 69, 0.7);
            border-color: rgba(139,92,246,0.3);
        }
        body.wizard-mode .ai-answer-card {
            background: linear-gradient(135deg, rgba(26,17,69,0.9) 0%, rgba(13,27,62,0.9) 100%) !important;
            border-color: rgba(139,92,246,0.4) !important;
            border-left-color: #8b5cf6 !important;
        }
        body.wizard-mode .ai-answer-title { color: #fbbf24 !important; }
        body.wizard-mode .ai-main-answer { color: #e2d9f3 !important; }
        body.wizard-mode .quote-box {
            background: rgba(10,14,39,0.6) !important;
            border-color: rgba(139,92,246,0.3) !important;
        }
        body.wizard-mode .quote-content { color: rgba(226,217,243,0.8) !important; }
        body.wizard-mode .status-indicator { background: rgba(5,118,66,0.2); }
        body.wizard-mode .user-name { color: #e2d9f3; }
        body.wizard-mode .user-avatar { background: #8b5cf6; }
        body.wizard-mode .detected-badge { background: rgba(139,92,246,0.2); color: #a78bfa; border-color: rgba(139,92,246,0.3); }
        body.wizard-mode .autocomplete-dropdown { background: rgba(15,10,50,0.98); border-color: rgba(139,92,246,0.3); }
        body.wizard-mode .autocomplete-item { color: #e2d9f3; }
        body.wizard-mode .autocomplete-item:hover { background: rgba(139,92,246,0.2); }
        body.wizard-mode .wizard-speech-bubble {
            background: rgba(26,17,69,0.95);
            color: #e2d9f3;
            border: 1px solid rgba(139,92,246,0.3);
        }
        body.wizard-mode .wizard-speech-bubble::after { border-top-color: rgba(26,17,69,0.95); }
        body.wizard-mode .rank-display { background: rgba(139,92,246,0.15); border-color: rgba(139,92,246,0.3); color: #a78bfa; }

        /* Responsive */
        @media (max-width: 768px) {
            .hero { padding: 1rem 1rem 0.75rem; }
            .hero h1 { font-size: 1.75rem; }
            .hero p { font-size: 0.875rem; white-space: normal; }
            .search-container, .results-container { padding: 1rem; }
            .search-mode-toggle { flex-wrap: wrap; }
            .mode-btn { flex: 1; justify-content: center; min-width: 80px; }
            .results-grid { grid-template-columns: 1fr; }
            .card-header { flex-direction: column; gap: 0.5rem; }
            .card-balance { text-align: left; }
            .card-details { grid-template-columns: 1fr; }
            .card-financial { grid-template-columns: 1fr; }
            .search-btn span { display: none; }
            .search-hints { display: none; }
            .user-name { display: none; }
            .user-menu { gap: 4px; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo">
                <div class="logo-icon" id="logoIcon">
                    <i class="fas fa-wand-magic-sparkles"></i>
                    <img class="logo-wizard-img" src="https://storage.googleapis.com/pspm-community-images/wizard/wizard-character.png" alt="Wizard">
                </div>
                <div class="logo-text">
                    <span class="logo-title">Manager Wizard</span>
                    <span class="logo-subtitle">PS Property Management</span>
                    <!-- Build: v4-inline-preview -->
                </div>
            </a>
            <div style="display: flex; align-items: center; gap: 10px;">
                <div class="rank-display" id="rankDisplay">
                    <i class="fas fa-hat-wizard" id="rankIcon"></i>
                    <span id="rankTitle"></span>
                </div>
                <button class="wizard-toggle" id="wizardToggle" onclick="toggleWizardMode()" title="Toggle Wizard Mode">
                    <i class="fas fa-hat-wizard"></i>
                    <span>Wizard Mode</span>
                </button>
                <button class="voice-toggle" id="voiceToggle" onclick="toggleVoiceMode()" title="Toggle Voice Mode">
                    <i class="fas fa-microphone-alt"></i>
                    <span>Voice</span>
                </button>
                <div class="status-indicator" id="statusIndicator">
                    <span class="status-dot"></span>
                    <span id="statusText">Connected</span>
                </div>
                {% if user %}
                <div class="user-menu">
                    <div class="user-avatar" title="{{ user.name }}">
                        {{ user.first_name[0] if user.first_name else user.name[0] }}{{ user.last_name[0] if user.last_name else '' }}
                    </div>
                    <div class="user-info">
                        <span class="user-name">{{ user.first_name or user.name }}</span>
                        <a href="{{ url_for('logout') }}" class="logout-link" title="Sign out">
                            <i class="fas fa-sign-out-alt"></i>
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Hero -->
        <section class="hero">
            <h1>Ask me anything</h1>
            <p>Find homeowners by phone, address, or name  or ask about community rules, CC&Rs, and policies.</p>
        </section>

        <!-- Search Container -->
        <div class="search-container">
            <!-- Mode Toggle -->
            <div class="search-mode-toggle">
                <button class="mode-btn active" data-mode="auto">
                    <i class="fas fa-wand-magic-sparkles"></i>
                    <span>Auto-detect</span>
                </button>
                <button class="mode-btn" data-mode="homeowner">
                    <i class="fas fa-user"></i>
                    <span>Homeowners</span>
                </button>
                <button class="mode-btn" data-mode="document">
                    <i class="fas fa-file-alt"></i>
                    <span>Documents</span>
                </button>
                <button class="mode-btn" data-mode="both">
                    <i class="fas fa-layer-group"></i>
                    <span>Both</span>
                </button>
            </div>

            <!-- Search Box -->
            <div class="search-box">
                <input type="text"
                       class="search-input"
                       id="searchInput"
                       placeholder="Search by phone, address, name, or ask a question..."
                       autocomplete="off">
                <i class="fas fa-search search-icon"></i>
                <div class="search-orb" id="searchOrb"></div>
                <button class="search-btn" id="searchBtn">
                    <i class="fas fa-arrow-right"></i>
                    <span>Search</span>
                </button>
                <!-- Autocomplete Dropdown -->
                <div class="autocomplete-dropdown" id="autocompleteDropdown">
                    <div class="autocomplete-header">Communities</div>
                    <div id="autocompleteList"></div>
                </div>
            </div>

            <!-- Search Hints -->
            <div class="search-hints">
                <span class="hint-chip" data-query="512-555-1234"><i class="fas fa-phone"></i>Phone</span>
                <span class="hint-chip" data-query="7016 Walkup Lane"><i class="fas fa-map-marker-alt"></i>Address</span>
                <span class="hint-chip" data-query="fence height Falcon Pointe"><i class="fas fa-border-all"></i>Fence Rules</span>
                <span class="hint-chip" data-query="pool rules Vista Vera"><i class="fas fa-swimming-pool"></i>Pool Rules</span>
                <span class="hint-chip" data-query="parking policy"><i class="fas fa-car"></i>Parking</span>
                <span class="hint-chip" data-query="pet restrictions"><i class="fas fa-paw"></i>Pets</span>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <button class="quick-action-btn" data-community="Falcon Pointe">
                    <i class="fas fa-building"></i> Falcon Pointe
                </button>
                <button class="quick-action-btn" data-community="Avalon">
                    <i class="fas fa-building"></i> Avalon
                </button>
                <button class="quick-action-btn" data-community="Chandler Creek">
                    <i class="fas fa-building"></i> Chandler Creek
                </button>
                <button class="quick-action-btn" data-community="Heritage Park">
                    <i class="fas fa-building"></i> Heritage Park
                </button>
                <button class="quick-action-btn" data-community="Vista Vera">
                    <i class="fas fa-building"></i> Vista Vera
                </button>
            </div>
        </div>

        <!-- Results Container -->
        <div class="results-container" id="resultsContainer" style="display: none;">
            <div id="resultsContent"></div>
        </div>
    </div>

    <script>
        // State
        let currentMode = 'auto';
        let isSearching = false;
        let allCommunities = [];
        let autocompleteIndex = -1;
        let debounceTimer = null;

        // Elements
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const resultsContainer = document.getElementById('resultsContainer');
        const resultsContent = document.getElementById('resultsContent');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const autocompleteDropdown = document.getElementById('autocompleteDropdown');
        const autocompleteList = document.getElementById('autocompleteList');

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkStatus();
            setupEventListeners();
            loadCommunities();
            initGamification();
        });

        // Load all communities for autocomplete
        async function loadCommunities() {
            try {
                const resp = await fetch('/api/communities');
                const data = await resp.json();
                allCommunities = data.communities || [];
                console.log(`Loaded ${allCommunities.length} communities for autocomplete`);
            } catch (error) {
                console.error('Failed to load communities:', error);
            }
        }

        function setupEventListeners() {
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentMode = btn.dataset.mode;
                    updatePlaceholder();
                });
            });

            searchBtn.addEventListener('click', performSearch);
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    hideAutocomplete();
                    performSearch();
                }
            });

            // Autocomplete event listeners
            searchInput.addEventListener('input', handleAutocompleteInput);
            searchInput.addEventListener('keydown', handleAutocompleteKeydown);
            searchInput.addEventListener('blur', () => {
                // Delay to allow click on dropdown
                setTimeout(hideAutocomplete, 150);
            });
            searchInput.addEventListener('focus', () => {
                if (searchInput.value.length >= 2) {
                    showAutocomplete(searchInput.value);
                }
            });

            document.querySelectorAll('.hint-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    searchInput.value = chip.dataset.query;
                    performSearch();
                });
            });

            document.querySelectorAll('.quick-action-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    searchInput.value = btn.dataset.community;
                    currentMode = 'homeowner';
                    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                    document.querySelector('.mode-btn[data-mode="homeowner"]').classList.add('active');
                    performSearch();
                });
            });
        }

        // Autocomplete functions
        function handleAutocompleteInput(e) {
            const query = e.target.value.trim();

            // Debounce
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                if (query.length >= 2) {
                    showAutocomplete(query);
                } else {
                    hideAutocomplete();
                }
            }, 150);
        }

        function handleAutocompleteKeydown(e) {
            const items = autocompleteList.querySelectorAll('.autocomplete-item');
            if (!items.length) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                autocompleteIndex = Math.min(autocompleteIndex + 1, items.length - 1);
                updateAutocompleteSelection(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                autocompleteIndex = Math.max(autocompleteIndex - 1, -1);
                updateAutocompleteSelection(items);
            } else if (e.key === 'Tab' || (e.key === 'Enter' && autocompleteIndex >= 0)) {
                if (autocompleteIndex >= 0 && items[autocompleteIndex]) {
                    e.preventDefault();
                    selectAutocompleteItem(items[autocompleteIndex].dataset.name);
                }
            } else if (e.key === 'Escape') {
                hideAutocomplete();
            }
        }

        function updateAutocompleteSelection(items) {
            items.forEach((item, i) => {
                item.classList.toggle('selected', i === autocompleteIndex);
            });
        }

        function showAutocomplete(query) {
            const queryLower = query.toLowerCase();

            // Filter communities
            const matches = allCommunities.filter(c => {
                const name = (c.name || '').toLowerCase();
                const fullName = (c.full_name || '').toLowerCase();
                return name.includes(queryLower) || fullName.includes(queryLower);
            }).slice(0, 8);

            if (matches.length === 0) {
                hideAutocomplete();
                return;
            }

            // Build HTML
            autocompleteList.innerHTML = matches.map(c => `
                <div class="autocomplete-item" data-name="${c.name}" onclick="selectAutocompleteItem('${c.name.replace(/'/g, "\\'")}')">
                    <i class="fas fa-building"></i>
                    <span class="autocomplete-name">${highlightMatch(c.name, query)}</span>
                    <span class="autocomplete-code">${c.code || ''}</span>
                </div>
            `).join('');

            autocompleteDropdown.classList.add('show');
            autocompleteIndex = -1;
        }

        function highlightMatch(text, query) {
            const index = text.toLowerCase().indexOf(query.toLowerCase());
            if (index === -1) return text;
            return text.substring(0, index) +
                   '<strong>' + text.substring(index, index + query.length) + '</strong>' +
                   text.substring(index + query.length);
        }

        function hideAutocomplete() {
            autocompleteDropdown.classList.remove('show');
            autocompleteIndex = -1;
        }

        function selectAutocompleteItem(name) {
            searchInput.value = name;
            hideAutocomplete();
            // Focus input so user can continue typing or hit Enter to search
            searchInput.focus();
            // Move cursor to end of input
            searchInput.setSelectionRange(name.length, name.length);
        }

        // "Did You Mean?" click handler - this one SHOULD auto-search
        // since user is correcting a failed search
        function searchSuggestion(suggestion) {
            searchInput.value = suggestion;
            performSearch();
        }

        function updatePlaceholder() {
            const placeholders = {
                'auto': 'Search by phone, address, name, or ask a question...',
                'homeowner': 'Search homeowners by phone, address, or name...',
                'document': 'Ask about community rules and policies...',
                'both': 'Search everything...'
            };
            searchInput.placeholder = placeholders[currentMode] || placeholders['auto'];
        }

        async function checkStatus() {
            try {
                const resp = await fetch('/api/status');
                const data = await resp.json();

                if (data.status === 'connected') {
                    statusIndicator.querySelector('.status-dot').classList.remove('disconnected');
                    statusText.textContent = `Connected`;
                } else {
                    statusIndicator.querySelector('.status-dot').classList.add('disconnected');
                    statusText.textContent = 'Disconnected';
                }
            } catch (error) {
                statusIndicator.querySelector('.status-dot').classList.add('disconnected');
                statusText.textContent = 'Connection error';
            }
        }

        async function performSearch() {
            const query = searchInput.value.trim();
            if (!query || isSearching) return;

            isSearching = true;
            searchBtn.disabled = true;
            resultsContainer.style.display = 'block';

            resultsContent.innerHTML = `
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <p>Searching...</p>
                </div>
            `;

            try {
                const resp = await fetch(`/api/unified-search?q=${encodeURIComponent(query)}&mode=${currentMode}`);
                const data = await resp.json();

                if (data.error) {
                    showError(data.error);
                    return;
                }

                renderResults(data);
                incrementSearchCount();
                checkEasterEggs(query);
            } catch (error) {
                showError('Search failed. Please try again.');
                console.error('Search error:', error);
            } finally {
                isSearching = false;
                searchBtn.disabled = false;
            }
        }

        function showError(message) {
            resultsContent.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3>Oops!</h3>
                    <p>${escapeHtml(message)}</p>
                </div>
            `;
        }

        function renderResults(data) {
            const hasHomeowners = data.homeowners && data.homeowners.length > 0;
            const hasDocuments = data.documents && data.documents.length > 0;
            const hasAiAnswer = data.ai_answer && data.ai_answer.extracted;
            const hasSuggestions = data.community_suggestions && data.community_suggestions.length > 0;

            if (!hasHomeowners && !hasDocuments) {
                let emptyHtml = '';

                // Show "Did you mean?" suggestions if available
                if (hasSuggestions) {
                    emptyHtml += `
                        <div class="did-you-mean">
                            <i class="fas fa-wand-magic-sparkles did-you-mean-icon"></i>
                            <span class="did-you-mean-text">Did you mean:</span>
                            ${data.community_suggestions.map(s => `
                                <button class="did-you-mean-suggestion" onclick="searchSuggestion('${s.replace(/'/g, "\\'")}')">
                                    ${escapeHtml(s)}
                                </button>
                            `).join('')}
                        </div>
                    `;
                }

                emptyHtml += `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <h3>No results found</h3>
                        <p>${hasSuggestions ? 'Try one of the suggestions above or' : 'Try'} a different search term.</p>
                    </div>
                `;
                resultsContent.innerHTML = emptyHtml;
                return;
            }

            // Show suggestions even when we have some results but they might be wrong community
            let suggestionsHtml = '';
            if (hasSuggestions && !hasHomeowners) {
                suggestionsHtml = `
                    <div class="did-you-mean">
                        <i class="fas fa-wand-magic-sparkles did-you-mean-icon"></i>
                        <span class="did-you-mean-text">Looking for a different community?</span>
                        ${data.community_suggestions.map(s => `
                            <button class="did-you-mean-suggestion" onclick="searchSuggestion('${s.replace(/'/g, "\\'")}')">
                                ${escapeHtml(s)}
                            </button>
                        `).join('')}
                    </div>
                `;
            }

            let html = '';

            html += `
                <div class="results-header">
                    <div class="results-title">
                        Results for "${escapeHtml(data.query)}"
                    </div>
                    <span class="detected-badge">
                        ${data.detected_type === 'homeowner' ? 'Homeowner Search' :
                          data.detected_type === 'document' ? 'Document Search' : 'Combined Search'}
                    </span>
                </div>
            `;

            // Add "Did you mean?" suggestions if available
            html += suggestionsHtml;

            // Only show AI answer when NO homeowner results found (pure document searches)
            if (hasAiAnswer && !hasHomeowners) {
                html += renderAiAnswerCard(data.ai_answer, data.community_detected, data.documents, data.query);
            }

            if (hasHomeowners) {
                html += `
                    <div class="results-section">
                        <div class="section-header">
                            <div class="section-icon">
                                <i class="fas fa-user"></i>
                            </div>
                            <span class="section-title">Homeowners</span>
                            <span class="section-count">${data.homeowners.length}</span>
                        </div>
                        <div class="results-grid">
                            ${data.homeowners.map(h => renderHomeownerCard(h)).join('')}
                        </div>
                    </div>
                `;
            }

            if (hasDocuments && !hasAiAnswer) {
                // Only show documents list if there's NO AI answer
                html += `
                    <div class="results-section">
                        <div class="section-header">
                            <div class="section-icon document">
                                <i class="fas fa-file-alt"></i>
                            </div>
                            <span class="section-title">Documents</span>
                            <span class="section-count">${data.documents.length}</span>
                        </div>
                        <div class="results-grid">
                            ${data.documents.map((d, i) => renderDocumentCard(d, i)).join('')}
                        </div>
                    </div>
                `;
            }

            resultsContent.innerHTML = html;
        }

        function toggleDocuments(element) {
            element.classList.toggle('expanded');
            const collapsible = element.nextElementSibling;
            collapsible.classList.toggle('expanded');
        }

        function renderAiAnswerCard(aiAnswer, community, documents, query) {
            const extracted = aiAnswer.extracted;
            const type = aiAnswer.extraction_type;

            // Check if we have a real answer or just "not found"
            const answerLower = (extracted.answer || '').toLowerCase();
            const hasNoAnswer = !extracted.answer ||
                answerLower.includes('not found') ||
                answerLower.includes('no specific') ||
                answerLower.includes('could not find') ||
                answerLower.includes('no pool') ||
                answerLower.includes('no pet') ||
                answerLower.includes('no parking') ||
                answerLower.includes('no fence') ||
                answerLower.includes('not available') ||
                answerLower.includes('unable to find') ||
                answerLower.includes('unable to determine') ||
                answerLower.includes('cannot determine') ||
                answerLower.includes('no information') ||
                answerLower.includes('no mention') ||
                answerLower.includes('does not mention') ||
                answerLower.includes('does not address') ||
                answerLower.includes('does not contain') ||
                answerLower.startsWith('no ') ||
                answerLower.includes('additional documents') ||
                answerLower.includes('more specific search');

            if (hasNoAnswer) {
                return `
                    <div class="ai-answer-card" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-color: #fbbf24; border-left-color: #f59e0b;">
                        <div class="ai-answer-header">
                            <div class="ai-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                                <i class="fas fa-search"></i>
                            </div>
                            <div>
                                <div class="ai-answer-title" style="color: #b45309;">No Specific Answer Found</div>
                                <div class="ai-answer-subtitle">${community ? `For ${escapeHtml(community)}` : 'In available documents'}</div>
                            </div>
                        </div>
                        <div class="ai-main-answer" style="font-size: 1.25rem;">${escapeHtml(extracted.answer || 'Could not find specific information in the indexed documents.')}</div>
                        <div class="ai-summary">Try a different search term, or the information may not be in the indexed documents yet.</div>
                    </div>
                `;
            }

            // We have an answer! Show it prominently
            const mainAnswer = extracted.answer || extracted.summary || '';
            const sourceName = extracted.source || (extracted.documents_found && extracted.documents_found[0]) || '';

            // Find the source document from the documents array
            let sourceDoc = null;
            let sourceUrl = '';
            if (sourceName && documents) {
                sourceDoc = documents.find(d =>
                    d.title && d.title.toLowerCase().includes(sourceName.toLowerCase().replace('.pdf', ''))
                );
                if (sourceDoc && sourceDoc.url) {
                    sourceUrl = sourceDoc.url;
                }
            }
            // Fallback to first document if no specific source match
            if (!sourceDoc && documents && documents.length > 0) {
                sourceDoc = documents[0];
                if (!sourceUrl && sourceDoc.url) sourceUrl = sourceDoc.url;
            }

            // Get caption with highlights from first document if available
            let captionHighlighted = '';
            if (documents && documents.length > 0 && documents[0].caption_highlighted) {
                captionHighlighted = documents[0].caption_highlighted;
            }

            // Build source document preview - show RELEVANT EXCERPT only, not full document
            const previewId = 'ai-source-preview-' + Math.random().toString(36).substr(2, 9);
            let sourceContentHtml = '';
            if (sourceDoc && sourceDoc.content) {
                const fullText = sourceDoc.content;
                const searchInput = document.getElementById('searchInput');
                const queryWords = (searchInput && searchInput.value)
                    ? searchInput.value.toLowerCase().split(/\s+/).filter(w => w.length > 2)
                    : [];
                const skipWords = ['the', 'and', 'for', 'are', 'was', 'who', 'what', 'how', 'does', 'rules', 'responsible', 'owner', 'maintenance', 'can', 'long', 'stay'];
                const highlightWords = queryWords.filter(w => !skipWords.includes(w));

                // Find the most relevant excerpt by locating where keywords cluster
                let bestPos = 0;
                let bestScore = -1;
                const lowerText = fullText.toLowerCase();
                const windowSize = 800;

                // Also use the AI answer/quote to find the best spot
                const answerText = (extracted.answer || extracted.quote || '').toLowerCase();
                const answerWords = answerText.split(/\s+/).filter(w => w.length > 3).slice(0, 5);
                const allSearchTerms = [...highlightWords, ...answerWords];

                for (let i = 0; i < fullText.length - 100; i += 50) {
                    const window = lowerText.substring(i, i + windowSize);
                    let score = 0;
                    allSearchTerms.forEach(word => {
                        const idx = window.indexOf(word.toLowerCase());
                        if (idx !== -1) score += 3;
                    });
                    if (score > bestScore) {
                        bestScore = score;
                        bestPos = i;
                    }
                }

                // Extract excerpt with some padding
                const excerptStart = Math.max(0, bestPos - 100);
                const excerptEnd = Math.min(fullText.length, bestPos + windowSize + 100);
                let excerpt = fullText.substring(excerptStart, excerptEnd).trim();

                // Add ellipsis if trimmed
                if (excerptStart > 0) excerpt = '...' + excerpt;
                if (excerptEnd < fullText.length) excerpt = excerpt + '...';

                // Escape and highlight
                let text = escapeHtml(excerpt);
                highlightWords.forEach(word => {
                    const regex = new RegExp(`(${word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                    text = text.replace(regex, '<mark>$1</mark>');
                });
                sourceContentHtml = text;
            }

            // Generate unique ID for this answer card
            const answerId = 'answer-' + Math.random().toString(36).substr(2, 9);
            const quoteText = extracted.quote || (captionHighlighted ? captionHighlighted.replace(/<[^>]*>/g, '') : '');
            const hasSourceContent = sourceContentHtml.length > 0;

            return `
                <div class="ai-answer-card" id="${answerId}">
                    <div class="ai-answer-header">
                        <div class="ai-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div>
                            <div class="ai-answer-title">Answer Found</div>
                            <div class="ai-answer-subtitle">${community ? `For ${escapeHtml(community)}` : 'From community documents'}</div>
                        </div>
                    </div>
                    <div class="ai-main-answer">${escapeHtml(mainAnswer)}</div>
                    ${extracted.quote || captionHighlighted ? `
                        <div class="quote-box">
                            <div class="quote-icon"><i class="fas fa-quote-left"></i></div>
                            <div class="quote-content">
                                ${captionHighlighted ? captionHighlighted : escapeHtml(extracted.quote)}
                            </div>
                            ${sourceName ? `
                                <div class="quote-source">
                                    <i class="fas fa-file-pdf"></i>
                                    <span>${escapeHtml(sourceName)}</span>
                                    ${hasSourceContent ? `
                                        <button class="btn-view-source" onclick="toggleAiSourcePreview('${previewId}', this)">
                                            <i class="fas fa-eye"></i> View Source Document
                                        </button>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                    ` : (sourceName ? `
                        <div class="ai-source-section">
                            <div class="ai-source-label">Source Document</div>
                            <div class="ai-source-doc">
                                <i class="fas fa-file-pdf"></i>
                                <span>${escapeHtml(sourceName)}</span>
                                ${hasSourceContent ? `
                                    <button class="btn-view-source" onclick="toggleAiSourcePreview('${previewId}', this)">
                                        <i class="fas fa-eye"></i> View Source Document
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    ` : '')}

                    <!-- Inline Source Document Preview -->
                    ${hasSourceContent ? `
                    <div id="${previewId}" class="doc-preview-panel ai-source-panel" data-pdf-url="${sourceUrl ? escapeHtml(sourceUrl) : ''}">
                        <div class="doc-preview-inner">
                            <div class="doc-preview-toolbar">
                                <div class="doc-preview-toolbar-left">
                                    <i class="fas fa-file-alt"></i>
                                    <span class="doc-preview-toolbar-title">${escapeHtml(sourceDoc.title || sourceName)}</span>
                                </div>
                                <div class="doc-preview-toolbar-actions">
                                    <button onclick="toggleAiSourcePreview('${previewId}', null)">
                                        <i class="fas fa-times"></i> Close
                                    </button>
                                </div>
                            </div>
                            <div class="doc-preview-body">
                                <!-- PDF Thumbnail -->
                                <div class="pdf-thumbnail-section" id="${previewId}-pdf">
                                    <div class="pdf-thumbnail-loading">
                                        <i class="fas fa-spinner"></i> Loading document preview...
                                    </div>
                                </div>
                                <div class="doc-preview-divider">Relevant Excerpt</div>
                                <div class="doc-preview-content">
                                    <div class="doc-preview-content-text">${sourceContentHtml}</div>
                                </div>
                            </div>
                            <div class="doc-preview-footer">
                                <span>Page 1 preview &middot; Highlighted excerpt below</span>
                                ${sourceUrl ? `
                                    <a href="${escapeHtml(sourceUrl)}" target="_blank">
                                        <i class="fas fa-external-link-alt"></i> Open full document in SharePoint
                                    </a>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    <div class="ai-answer-actions" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                        <button class="copy-email-btn"
                            data-card-id="${answerId}"
                            data-query="${escapeHtml(query || '')}"
                            onclick="copyAnswerAsImage(this)"
                            title="Copy as image for email">
                            <i class="fas fa-image"></i> Copy for Email
                        </button>
                    </div>
                </div>
            `;
        }

        function renderHomeownerCard(h) {
            const isAttorney = h.collection_status && h.collection_status.toLowerCase().includes('attorney');

            let cardClass = 'homeowner-card';
            if (isAttorney) {
                cardClass += ' status-attorney';
            } else if (h.collection_indicator === 'collections') {
                cardClass += ' status-collections';
            } else if (h.balance_status === 'owed') {
                cardClass += ' status-owed';
            } else if (h.balance_status === 'credit') {
                cardClass += ' status-credit';
            }

            // Board member badge (shows alongside other badges)
            let boardMemberBadge = '';
            if (h.is_board_member) {
                boardMemberBadge = '<span class="status-badge badge-board-member"><i class="fas fa-star"></i> BOARD MEMBER</span>';
            }

            // New owner badge (settled within 90 days)
            let newOwnerBadge = '';
            if (h.is_new_owner) {
                newOwnerBadge = '<span class="status-badge badge-new-owner"><i class="fas fa-user-plus"></i> NEW OWNER</span>';
            }

            // Tenant badge (property is rented)
            let tenantBadge = '';
            if (h.is_tenant) {
                tenantBadge = '<span class="status-badge badge-tenant"><i class="fas fa-home-user"></i> TENANT</span>';
            }

            // Payment plan badge
            let paymentPlanBadge = '';
            if (h.has_payment_plan) {
                paymentPlanBadge = '<span class="status-badge badge-payment-plan"><i class="fas fa-calendar-check"></i> PAYMENT PLAN</span>';
            }

            // Longtime owner badge (10+ years)
            let longtimeOwnerBadge = '';
            if (h.is_longtime_owner) {
                longtimeOwnerBadge = '<span class="status-badge badge-longtime-owner"><i class="fas fa-award"></i> VIP</span>';
            }

            let statusBadge = '';
            if (isAttorney) {
                statusBadge = '<span class="status-badge badge-attorney">ATTORNEY</span>';
            } else if (h.collection_indicator === 'collections') {
                statusBadge = '<span class="status-badge badge-collections">In Collections</span>';
            } else if (h.collection_indicator === '60_days') {
                statusBadge = '<span class="status-badge badge-60days">60+ Days</span>';
            } else if (h.collection_indicator === '30_days') {
                statusBadge = '<span class="status-badge badge-30days">30+ Days</span>';
            }

            let balanceClass = 'balance-current';
            if (h.balance > 1000) balanceClass = 'balance-high';
            else if (h.balance > 500) balanceClass = 'balance-medium';
            else if (h.balance > 0) balanceClass = 'balance-low';
            else if (h.balance_status === 'credit') balanceClass = 'balance-credit';

            let tagsHtml = '';
            if (h.tenant_name || h.collection_provider || h.unit_lot) {
                tagsHtml = '<div class="card-tags">';
                if (h.tenant_name) {
                    tagsHtml += `<span class="tag-badge tenant"><i class="fas fa-user-friends"></i> Tenant: ${escapeHtml(h.tenant_name)}</span>`;
                }
                if (h.collection_provider) {
                    tagsHtml += `<span class="tag-badge collections-provider"><i class="fas fa-gavel"></i> ${escapeHtml(h.collection_provider)}</span>`;
                }
                if (h.unit_lot) {
                    tagsHtml += `<span class="tag-badge"><i class="fas fa-door-open"></i> ${escapeHtml(h.unit_lot)}</span>`;
                }
                tagsHtml += '</div>';
            }

            let financialHtml = '';
            if (h.last_payment && !isAttorney) {
                financialHtml = `
                    <div class="card-financial">
                        <div class="financial-item">
                            <div class="financial-value ${h.balance > 0 ? 'negative' : (h.balance_status === 'credit' ? 'positive' : '')}">${escapeHtml(h.balance_display)}</div>
                            <div class="financial-label">Balance</div>
                        </div>
                        <div class="financial-item">
                            <div class="financial-value positive">${escapeHtml(h.last_payment.amount)}</div>
                            <div class="financial-label">Last Payment</div>
                        </div>
                        <div class="financial-item">
                            <div class="financial-value">${escapeHtml(h.last_payment.date)}</div>
                            <div class="financial-label">Payment Date</div>
                        </div>
                    </div>
                `;
            }

            let attorneyWarningHtml = '';
            if (isAttorney) {
                attorneyWarningHtml = `
                    <div class="attorney-warning">
                        <div class="attorney-warning-title">
                            <i class="fas fa-exclamation-triangle"></i>
                            ACCOUNT WITH ATTORNEY
                        </div>
                        <div class="attorney-warning-text">
                            This account has been referred to an attorney for collections.<br>
                            <strong>Do NOT discuss balance or payment details with the homeowner.</strong>
                        </div>
                        ${h.collection_provider ? `
                            <div class="attorney-contact">
                                <div class="attorney-name">${escapeHtml(h.collection_provider)}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            const balanceHeaderHtml = isAttorney ? '' : `
                <div class="card-balance">
                    <div class="balance-amount ${balanceClass}">${escapeHtml(h.balance_display)}</div>
                    <div class="balance-label">${h.balance_status === 'credit' ? 'Credit Balance' : 'Balance'}</div>
                </div>
            `;

            // Generate unique ID for this card
            const cardId = 'homeowner-' + Math.random().toString(36).substr(2, 9);

            return `
                <div class="${cardClass}" id="${cardId}">
                    <div class="card-header">
                        <div>
                            <div class="card-name">${escapeHtml(h.owner_name)}</div>
                            <div class="card-community">${escapeHtml(h.community)}</div>
                            ${boardMemberBadge}${newOwnerBadge}${longtimeOwnerBadge}${tenantBadge}${paymentPlanBadge}${statusBadge}
                        </div>
                        ${balanceHeaderHtml}
                    </div>
                    ${attorneyWarningHtml}
                    ${tagsHtml}
                    ${financialHtml}
                    <div class="card-details">
                        <div class="detail-item">
                            <div class="detail-icon"><i class="fas fa-map-marker-alt"></i></div>
                            <div class="detail-content">
                                <div class="detail-label">Address</div>
                                <div class="detail-value">${escapeHtml(h.property_address)}</div>
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-icon"><i class="fas fa-phone"></i></div>
                            <div class="detail-content">
                                <div class="detail-label">Phone</div>
                                <div class="detail-value">
                                    ${h.phone !== 'N/A' ? `<a href="tel:${h.phone}">${escapeHtml(h.phone)}</a>` : 'N/A'}
                                </div>
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-icon"><i class="fas fa-envelope"></i></div>
                            <div class="detail-content">
                                <div class="detail-label">Email</div>
                                <div class="detail-value">
                                    ${h.email !== 'N/A' ? `<a href="mailto:${h.email}">${escapeHtml(h.email)}</a>` : 'N/A'}
                                </div>
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-icon"><i class="fas fa-hashtag"></i></div>
                            <div class="detail-content">
                                <div class="detail-label">Account</div>
                                <div class="detail-value">${escapeHtml(h.account_number)}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Account Ledger Section -->
                    ${!isAttorney ? `
                    <div class="ledger-section">
                        <button class="ledger-toggle" data-account="${escapeHtml(h.account_number)}" onclick="toggleLedger(this)">
                            <i class="fas fa-receipt"></i>
                            <span>View Account Ledger</span>
                            <i class="fas fa-chevron-down toggle-icon"></i>
                        </button>
                        <div class="ledger-container" id="ledger-${escapeHtml(h.account_number).replace(/[^a-zA-Z0-9]/g, '')}">
                            <!-- Ledger content loads here -->
                        </div>
                    </div>
                    ` : ''}

                    <div class="card-actions">
                        ${h.vantaca_url ? `
                            <a href="${escapeHtml(h.vantaca_url)}" target="_blank" class="btn btn-primary">
                                <i class="fas fa-external-link-alt"></i> Open in Vantaca
                            </a>
                        ` : ''}
                        <button class="copy-email-btn"
                            data-name="${escapeHtml(h.owner_name)}"
                            data-community="${escapeHtml(h.community)}"
                            data-address="${escapeHtml(h.property_address)}"
                            data-phone="${escapeHtml(h.phone)}"
                            data-email="${escapeHtml(h.email)}"
                            data-account="${escapeHtml(h.account_number)}"
                            data-balance="${escapeHtml(h.balance_display)}"
                            data-balance-status="${escapeHtml(h.balance_status || '')}"
                            onclick="copyHomeownerForEmail(this)"
                            title="Copy formatted info for email">
                            <i class="fas fa-envelope"></i> Copy for Email
                        </button>
                    </div>
                </div>
            `;
        }

        function renderDocumentCard(doc, index) {
            const typeInfo = doc.doc_type_info || { icon: 'file-alt', color: '#0078d4', label: 'Document' };
            const previewId = `doc-preview-${index}`;
            const hasContent = doc.content && doc.content.trim().length > 0;
            const hasUrl = !!doc.url;

            // Build the full content with highlighted search terms
            let contentHtml = '';
            const rawContent = doc.content || '';
            if (rawContent) {
                let text = escapeHtml(rawContent);
                // Highlight search terms from the query
                const searchInput = document.getElementById('searchInput');
                if (searchInput && searchInput.value) {
                    const queryWords = searchInput.value.toLowerCase().split(/\s+/).filter(w => w.length > 2);
                    const skipWords = ['the', 'and', 'for', 'are', 'was', 'who', 'what', 'how', 'does', 'rules', 'responsible', 'owner', 'maintenance'];
                    const highlightWords = queryWords.filter(w => !skipWords.includes(w));
                    highlightWords.forEach(word => {
                        const regex = new RegExp(`(${word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                        text = text.replace(regex, '<mark>$1</mark>');
                    });
                }
                contentHtml = text;
            }

            return `
                <div class="document-card" style="--doc-color: ${typeInfo.color}">
                    <div class="doc-header">
                        <div class="doc-icon" style="background: ${typeInfo.color}">
                            <i class="fas fa-${typeInfo.icon}"></i>
                        </div>
                        <div class="doc-title-section">
                            <div class="doc-type-label">${escapeHtml(typeInfo.label)}</div>
                            <div class="doc-title">${escapeHtml(doc.title)}</div>
                            ${doc.community ? `
                                <div class="doc-community">
                                    <i class="fas fa-building"></i>
                                    ${escapeHtml(doc.community)}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="doc-meta">
                        <div class="doc-meta-item">
                            <i class="fas fa-star"></i>
                            ${doc.score ? doc.score.toFixed(2) : 'N/A'} relevance
                        </div>
                    </div>
                    <div class="doc-actions">
                        ${hasContent ? `
                            <button class="btn-preview-toggle" onclick="toggleDocPreview('${previewId}', this)">
                                <i class="fas fa-eye"></i> Preview
                                <i class="fas fa-chevron-down toggle-chevron"></i>
                            </button>
                        ` : ''}
                        <button class="btn btn-secondary" onclick="copyToClipboard('${escapeHtml(doc.title)}')">
                            <i class="fas fa-copy"></i> Copy Title
                        </button>
                    </div>

                    <!-- Expandable Preview Panel -->
                    <div id="${previewId}" class="doc-preview-panel" data-pdf-url="${hasUrl ? escapeHtml(doc.url) : ''}">
                        <div class="doc-preview-inner">
                            <div class="doc-preview-toolbar">
                                <div class="doc-preview-toolbar-left">
                                    <i class="fas fa-${typeInfo.icon}"></i>
                                    <span class="doc-preview-toolbar-title">${escapeHtml(doc.title)}</span>
                                </div>
                                <div class="doc-preview-toolbar-actions">
                                    <button onclick="toggleDocPreview('${previewId}', this.closest('.document-card').querySelector('.btn-preview-toggle'))">
                                        <i class="fas fa-times"></i> Close
                                    </button>
                                </div>
                            </div>
                            <div class="doc-preview-body">
                                <!-- PDF Thumbnail -->
                                <div class="pdf-thumbnail-section" id="${previewId}-pdf">
                                    <div class="pdf-thumbnail-loading">
                                        <i class="fas fa-spinner"></i> Loading document preview...
                                    </div>
                                </div>
                                ${contentHtml ? `
                                    <div class="doc-preview-divider">Relevant Excerpt</div>
                                    <div class="doc-preview-content">
                                        <div class="doc-preview-content-text">${contentHtml}</div>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="doc-preview-footer">
                                <span>Page 1 preview &middot; Highlighted excerpt below</span>
                                ${hasUrl ? `
                                    <a href="${escapeHtml(doc.url)}" target="_blank">
                                        <i class="fas fa-external-link-alt"></i> Open full document in SharePoint
                                    </a>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Track which panels already have PDF thumbnails loaded
        const _pdfLoadedPanels = new Set();

        function renderPdfThumbnail(panelId) {
            if (_pdfLoadedPanels.has(panelId)) return; // Already loaded
            const panel = document.getElementById(panelId);
            if (!panel) return;

            const pdfUrl = panel.getAttribute('data-pdf-url');
            const pdfContainer = document.getElementById(panelId + '-pdf');
            if (!pdfContainer) return;

            // Only try for PDF files
            if (!pdfUrl || !pdfUrl.toLowerCase().match(/\.pdf/)) {
                pdfContainer.innerHTML = '<div class="pdf-thumbnail-error"><i class="fas fa-file-alt"></i> Text-based document &mdash; excerpt shown below</div>';
                _pdfLoadedPanels.add(panelId);
                return;
            }

            if (typeof pdfjsLib === 'undefined') {
                pdfContainer.innerHTML = '<div class="pdf-thumbnail-error">PDF preview unavailable</div>';
                _pdfLoadedPanels.add(panelId);
                return;
            }

            _pdfLoadedPanels.add(panelId);

            // Fetch PDF through our proxy to handle SharePoint auth
            const proxyUrl = '/api/pdf-proxy?url=' + encodeURIComponent(pdfUrl);

            pdfjsLib.getDocument(proxyUrl).promise.then(function(pdf) {
                // Render page 1
                pdf.getPage(1).then(function(page) {
                    // Scale to fit ~500px width
                    const desiredWidth = 500;
                    const unscaledViewport = page.getViewport({ scale: 1 });
                    const scale = desiredWidth / unscaledViewport.width;
                    const viewport = page.getViewport({ scale: scale });

                    const canvas = document.createElement('canvas');
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    const ctx = canvas.getContext('2d');

                    page.render({ canvasContext: ctx, viewport: viewport }).promise.then(function() {
                        pdfContainer.innerHTML = '';
                        const wrapper = document.createElement('div');
                        wrapper.className = 'pdf-thumbnail-wrapper';
                        wrapper.appendChild(canvas);
                        pdfContainer.appendChild(wrapper);
                        const label = document.createElement('div');
                        label.className = 'pdf-thumbnail-label';
                        label.textContent = 'Page 1 of ' + pdf.numPages;
                        pdfContainer.appendChild(label);
                    });
                });
            }).catch(function(err) {
                console.warn('PDF thumbnail failed:', err);
                pdfContainer.innerHTML = '<div class="pdf-thumbnail-error"><i class="fas fa-file-pdf"></i> Preview unavailable &mdash; <a href="' + pdfUrl + '" target="_blank" style="color:var(--primary)">open in SharePoint</a></div>';
            });
        }

        function toggleDocPreview(previewId, btn) {
            const panel = document.getElementById(previewId);
            if (!panel) return;

            const isOpen = panel.classList.contains('open');

            if (isOpen) {
                panel.classList.remove('open');
                if (btn) btn.classList.remove('active');
            } else {
                // Close any other open previews first
                document.querySelectorAll('.doc-preview-panel.open').forEach(p => {
                    p.classList.remove('open');
                    const otherBtn = p.closest('.document-card').querySelector('.btn-preview-toggle');
                    if (otherBtn) otherBtn.classList.remove('active');
                });
                panel.classList.add('open');
                if (btn) btn.classList.add('active');
                // Render PDF thumbnail on first open
                renderPdfThumbnail(previewId);
                // Scroll the panel into view smoothly
                setTimeout(() => {
                    panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 350);
            }
        }

        function toggleAiSourcePreview(previewId, btn) {
            const panel = document.getElementById(previewId);
            if (!panel) return;

            const isOpen = panel.classList.contains('open');

            if (isOpen) {
                panel.classList.remove('open');
                if (btn) btn.classList.remove('active');
            } else {
                // Close any other open source previews
                document.querySelectorAll('.ai-source-panel.open').forEach(p => {
                    p.classList.remove('open');
                });
                panel.classList.add('open');
                if (btn) btn.classList.add('active');
                // Render PDF thumbnail on first open
                renderPdfThumbnail(previewId);
                setTimeout(() => {
                    panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 350);
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                console.log('Copied:', text);
            });
        }

        // ========================================
        // Account Ledger Functions
        // ========================================
        const ledgerCache = {};

        function toggleLedger(btn) {
            const account = btn.dataset.account;
            const containerId = 'ledger-' + account.replace(/[^a-zA-Z0-9]/g, '');
            const container = document.getElementById(containerId);
            const icon = btn.querySelector('.toggle-icon');

            if (container.classList.contains('show')) {
                container.classList.remove('show');
                btn.classList.remove('active');
                icon.style.transform = 'rotate(0deg)';
            } else {
                container.classList.add('show');
                btn.classList.add('active');
                icon.style.transform = 'rotate(180deg)';

                // Load ledger data if not already loaded
                if (!ledgerCache[account]) {
                    loadLedger(account, container);
                }
            }
        }

        async function loadLedger(account, container) {
            container.innerHTML = '<div class="ledger-loading"><i class="fas fa-spinner fa-spin"></i> Loading ledger...</div>';

            try {
                const response = await fetch(`/api/history?account=${encodeURIComponent(account)}&limit=15`);
                const data = await response.json();

                if (data.error) {
                    container.innerHTML = `<div class="ledger-error"><i class="fas fa-exclamation-triangle"></i> ${data.error}</div>`;
                    return;
                }

                if (!data.history || data.history.length === 0) {
                    container.innerHTML = '<div class="ledger-empty"><i class="fas fa-info-circle"></i> No recent transactions found</div>';
                    return;
                }

                ledgerCache[account] = data.history;
                renderLedgerTable(data.history, container);

            } catch (err) {
                container.innerHTML = `<div class="ledger-error"><i class="fas fa-exclamation-triangle"></i> Failed to load ledger</div>`;
                console.error('Ledger load error:', err);
            }
        }

        function renderLedgerTable(history, container) {
            let html = `
                <table class="ledger-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th class="amount">Charge</th>
                            <th class="amount">Payment</th>
                            <th class="amount">Balance</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // History should already be sorted with most recent first from the API
            history.forEach(item => {
                const date = item.date || 'N/A';
                const desc = item.description || 'N/A';
                const charge = item.charge ? formatCurrency(item.charge) : '-';
                const payment = item.payment ? formatCurrency(item.payment) : '-';
                const balance = item.running_balance !== null ? formatCurrency(item.running_balance) : '-';

                const balanceClass = item.running_balance < 0 ? 'credit' : (item.running_balance > 0 ? 'debit' : '');

                html += `
                    <tr>
                        <td class="date">${escapeHtml(date)}</td>
                        <td class="description">${escapeHtml(desc)}</td>
                        <td class="amount charge">${charge !== '-' ? charge : '<span class="dash">-</span>'}</td>
                        <td class="amount payment">${payment !== '-' ? payment : '<span class="dash">-</span>'}</td>
                        <td class="amount balance ${balanceClass}">${balance}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        function formatCurrency(value) {
            if (value === null || value === undefined) return '-';
            const num = parseFloat(value);
            if (isNaN(num)) return '-';
            return '$' + Math.abs(num).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        // Copy homeowner info as formatted HTML for emails
        function copyHomeownerForEmail(btn) {
            const data = {
                name: btn.dataset.name || 'N/A',
                community: btn.dataset.community || 'N/A',
                address: btn.dataset.address || 'N/A',
                phone: btn.dataset.phone || 'N/A',
                email: btn.dataset.email || 'N/A',
                account: btn.dataset.account || 'N/A',
                balance: btn.dataset.balance || 'N/A',
                balance_status: btn.dataset.balanceStatus || ''
            };
            const balanceColor = data.balance_status === 'credit' ? '#059669' :
                                 (parseFloat(data.balance?.replace(/[$,]/g, '')) > 500 ? '#dc2626' : '#ea580c');

            const html = `
<table style="border-collapse: collapse; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 8px; border: 1px solid #e2e8f0; width: 100%; max-width: 400px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
    <tr>
        <td style="padding: 16px; border-bottom: 1px solid #e2e8f0;">
            <div style="font-size: 16px; font-weight: 700; color: #1e293b; margin-bottom: 4px;">${data.name || 'N/A'}</div>
            <div style="font-size: 13px; color: #64748b;">${data.community || 'N/A'}</div>
        </td>
        <td style="padding: 16px; border-bottom: 1px solid #e2e8f0; text-align: right;">
            <div style="font-size: 18px; font-weight: 700; color: ${balanceColor};">${data.balance || 'N/A'}</div>
            <div style="font-size: 11px; color: #94a3b8; text-transform: uppercase;">${data.balance_status === 'credit' ? 'Credit' : 'Balance'}</div>
        </td>
    </tr>
    <tr>
        <td colspan="2" style="padding: 12px 16px;">
            <table style="width: 100%; border-collapse: collapse;">
                <tr>
                    <td style="padding: 6px 0; color: #64748b; font-size: 12px; width: 70px;">Address</td>
                    <td style="padding: 6px 0; color: #1e293b; font-size: 13px;">${data.address || 'N/A'}</td>
                </tr>
                <tr>
                    <td style="padding: 6px 0; color: #64748b; font-size: 12px;">Phone</td>
                    <td style="padding: 6px 0; color: #1e293b; font-size: 13px;">${data.phone || 'N/A'}</td>
                </tr>
                <tr>
                    <td style="padding: 6px 0; color: #64748b; font-size: 12px;">Email</td>
                    <td style="padding: 6px 0; color: #1e293b; font-size: 13px;">${data.email || 'N/A'}</td>
                </tr>
                <tr>
                    <td style="padding: 6px 0; color: #64748b; font-size: 12px;">Account</td>
                    <td style="padding: 6px 0; color: #1e293b; font-size: 13px;">${data.account || 'N/A'}</td>
                </tr>
            </table>
        </td>
    </tr>
</table>`;

            copyHtmlToClipboard(html, btn);
        }

        // Copy AI answer card as image for emails
        async function copyAnswerAsImage(btn) {
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Capturing...';

            try {
                const cardId = btn.dataset.cardId;
                const query = btn.dataset.query || '';
                const card = document.getElementById(cardId);

                if (!card) {
                    throw new Error('Card not found');
                }

                // Create a wrapper with the question above the card
                const wrapper = document.createElement('div');
                wrapper.style.cssText = 'position: fixed; left: -9999px; top: 0; background: #ffffff; padding: 24px; max-width: 700px; font-family: Inter, -apple-system, BlinkMacSystemFont, sans-serif;';

                // Add the question at the top (larger text as requested)
                if (query) {
                    const questionDiv = document.createElement('div');
                    questionDiv.style.cssText = 'font-size: 20px; font-weight: 500; color: #1e293b; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid #e5e7eb;';
                    questionDiv.textContent = '"' + query + '"';
                    wrapper.appendChild(questionDiv);
                }

                // Clone the card (without the copy button and header)
                const cardClone = card.cloneNode(true);
                // Remove the actions div from the clone
                const actionsDiv = cardClone.querySelector('.ai-answer-actions');
                if (actionsDiv) {
                    actionsDiv.remove();
                }
                // Remove the "Answer Found" header from the clone
                const headerDiv = cardClone.querySelector('.ai-answer-header');
                if (headerDiv) {
                    headerDiv.remove();
                }
                wrapper.appendChild(cardClone);

                document.body.appendChild(wrapper);

                // Capture as canvas
                const canvas = await html2canvas(wrapper, {
                    backgroundColor: '#ffffff',
                    scale: 2, // Higher resolution
                    logging: false,
                    useCORS: true
                });

                document.body.removeChild(wrapper);

                // Convert to blob and copy
                canvas.toBlob(async (blob) => {
                    try {
                        await navigator.clipboard.write([
                            new ClipboardItem({ 'image/png': blob })
                        ]);
                        btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                        btn.classList.add('copied');
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                            btn.classList.remove('copied');
                        }, 2000);
                    } catch (clipErr) {
                        console.error('Clipboard write failed:', clipErr);
                        // Fallback: download the image
                        const link = document.createElement('a');
                        link.download = 'answer.png';
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                        btn.innerHTML = '<i class="fas fa-download"></i> Downloaded';
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                        }, 2000);
                    }
                }, 'image/png');

            } catch (err) {
                console.error('Image capture error:', err);
                btn.innerHTML = '<i class="fas fa-times"></i> Failed';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                }, 2000);
            }
        }

        // Copy AI answer as formatted HTML for emails (legacy fallback)
        function copyAnswerForEmail(btn) {
            const data = {
                community: btn.dataset.community || 'Community Documents',
                answer: btn.dataset.answer || '',
                quote: btn.dataset.quote || '',
                source: btn.dataset.source || ''
            };

            // Build quote section if we have a quote
            let quoteHtml = '';
            if (data.quote) {
                quoteHtml = `
                <tr>
                    <td style="padding: 16px 20px;">
                        <table cellpadding="0" cellspacing="0" border="0" width="100%" style="background-color: #ffffff; border-radius: 8px; border: 1px solid #e5e7eb; border-left: 4px solid #64748b;">
                            <tr>
                                <td width="40" valign="top" style="padding: 16px 0 16px 16px;">
                                    <div style="width: 32px; height: 32px; background-color: #64748b; border-radius: 16px; text-align: center; line-height: 32px;">
                                        <span style="color: white; font-size: 18px; font-weight: bold;">"</span>
                                    </div>
                                </td>
                                <td valign="top" style="padding: 16px 16px 16px 12px; font-size: 14px; color: #475569; line-height: 1.6;">${data.quote}</td>
                            </tr>
                            ${data.source ? `
                            <tr>
                                <td colspan="2" style="padding: 0 16px 12px 16px;">
                                    <div style="font-size: 12px; color: #94a3b8;">
                                        <span style="color: #ef4444;"></span> ${data.source}
                                    </div>
                                </td>
                            </tr>
                            ` : ''}
                        </table>
                    </td>
                </tr>`;
            } else if (data.source) {
                // Source without quote
                quoteHtml = `
                <tr>
                    <td style="padding: 0 20px 16px 20px;">
                        <div style="font-size: 12px; color: #94a3b8;">
                            <span style="color: #ef4444;"></span> Source: ${data.source}
                        </div>
                    </td>
                </tr>`;
            }

            const html = `<table cellpadding="0" cellspacing="0" border="0" width="100%" style="max-width: 550px; font-family: Arial, Helvetica, sans-serif;">
    <tr>
        <td>
            <table cellpadding="0" cellspacing="0" border="0" width="100%" style="background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%); background-color: #f0fdf4; border-radius: 12px; border: 1px solid #a7d8c4; border-left: 5px solid #10b981; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);">
                <tr>
                    <td style="padding: 20px 20px 12px 20px;">
                        <div style="font-size: 20px; font-weight: 700; color: #1e293b; line-height: 1.4;">${data.answer}</div>
                    </td>
                </tr>
                ${quoteHtml}
            </table>
        </td>
    </tr>
</table>`;

            copyHtmlToClipboard(html, btn);
        }

        // Helper to copy HTML to clipboard with fallback
        function copyHtmlToClipboard(html, btn) {
            const originalText = btn.innerHTML;

            // Show copying state
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Copying...';

            try {
                // Try to copy as HTML (for rich paste in Outlook/Gmail)
                const htmlBlob = new Blob([html], { type: 'text/html' });
                const textBlob = new Blob([html.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim()], { type: 'text/plain' });

                navigator.clipboard.write([
                    new ClipboardItem({
                        'text/html': htmlBlob,
                        'text/plain': textBlob
                    })
                ]).then(() => {
                    btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                    btn.classList.add('copied');
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.classList.remove('copied');
                    }, 2000);
                }).catch(err => {
                    console.error('Clipboard write failed:', err);
                    // Fallback - try execCommand
                    fallbackCopy(html, btn, originalText);
                });
            } catch (err) {
                console.error('Clipboard API error:', err);
                fallbackCopy(html, btn, originalText);
            }
        }

        // Fallback copy using execCommand
        function fallbackCopy(html, btn, originalText) {
            const container = document.createElement('div');
            container.innerHTML = html;
            container.style.position = 'fixed';
            container.style.left = '-9999px';
            document.body.appendChild(container);

            const range = document.createRange();
            range.selectNodeContents(container);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);

            try {
                document.execCommand('copy');
                btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                btn.classList.add('copied');
            } catch (err) {
                console.error('execCommand failed:', err);
                btn.innerHTML = '<i class="fas fa-times"></i> Failed';
            }

            selection.removeAllRanges();
            document.body.removeChild(container);

            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.remove('copied');
            }, 2000);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========================================
        // GAMIFICATION SYSTEM
        // ========================================

        const MILESTONES = [
            { count: 5, title: 'Apprentice', subtitle: 'A subtle spark of magic...', icon: 'fa-hat-wizard', effect: 'sparkle' },
            { count: 10, title: 'Wizard Revealed', subtitle: 'The Manager Wizard appears!', icon: 'fa-hat-wizard', effect: 'wizardReveal' },
            { count: 20, title: 'Sage', subtitle: 'The Wizard shares ancient wisdom...', icon: 'fa-scroll', effect: 'sage' },
            { count: 30, title: 'Archmage', subtitle: 'WIZARD MODE UNLOCKED!', icon: 'fa-crown', effect: 'wizardUnlock' },
            { count: 50, title: 'Grand Wizard', subtitle: 'The highest honor bestowed upon you!', icon: 'fa-gem', effect: 'grandWizard' },
            { count: 75, title: 'Legendary', subtitle: 'A secret power awakens...', icon: 'fa-bolt', effect: 'voiceUnlock' }
        ];

        const WIZARD_TIPS = [
            "Try searching by phone number for instant homeowner lookup!",
            "Use community names to find CC&Rs and governing documents.",
            "Search by address for the most precise results.",
            "Ask questions like 'fence height in Avalon' for AI-powered answers!",
            "Account numbers work too - try searching with or without leading zeros.",
            "Pro tip: Combine community name + topic for laser-focused doc search.",
            "The ancient scrolls reveal... pet policies are popular searches!",
            "A wise wizard searches by partial address when exact match fails.",
            "Did you know? Board member accounts show a special purple badge!",
            "New owners (< 90 days) get a cyan badge. Welcome them warmly!"
        ];

        const WIZARD_AUDIO_BASE = 'https://storage.googleapis.com/pspm-community-images/wizard/';
        const WIZARD_VOICE_LINES = {
            greeting: WIZARD_AUDIO_BASE + 'wizard-greeting.mp3',
            sage: WIZARD_AUDIO_BASE + 'wizard-sage.mp3',
            unlock: WIZARD_AUDIO_BASE + 'wizard-unlock.mp3',
            grand: WIZARD_AUDIO_BASE + 'wizard-grand.mp3',
            modeOn: WIZARD_AUDIO_BASE + 'wizard-mode-on.mp3',
            modeOff: WIZARD_AUDIO_BASE + 'wizard-mode-off.mp3'
        };

        function playWizardVoice(key) {
            const url = WIZARD_VOICE_LINES[key];
            if (!url) return;
            try {
                const audio = new Audio(url);
                audio.volume = 0.7;
                audio.play().catch(() => {});
            } catch (e) { /* Audio not available */ }
        }

        const EASTER_EGG_SEARCHES = {
            'abracadabra': 'particleBurst',
            'lumos': 'wizardOn',
            'nox': 'wizardOff',
            'expecto patronum': 'patronus',
            'open sesame': 'portalOpen'
        };

        // Gamification state
        let gamificationState = {
            searchCount: 0,
            wizardUnlocked: false,
            wizardActive: false,
            voiceUnlocked: false,
            voiceActive: false,
            shownMilestones: [],
            currentRank: null
        };

        function initGamification() {
            // Check for reset URL parameter
            if (new URLSearchParams(window.location.search).get('reset') === 'wizard') {
                resetWizard();
                // Clean up URL
                window.history.replaceState({}, '', window.location.pathname);
                return;
            }

            // Load persisted state
            gamificationState.searchCount = parseInt(localStorage.getItem('mw_search_count') || '0');
            gamificationState.wizardUnlocked = localStorage.getItem('mw_wizard_unlocked') === 'true';
            gamificationState.wizardActive = localStorage.getItem('mw_wizard_active') === 'true';
            gamificationState.voiceUnlocked = localStorage.getItem('mw_voice_unlocked') === 'true';
            gamificationState.voiceActive = localStorage.getItem('mw_voice_active') === 'true';
            gamificationState.shownMilestones = JSON.parse(localStorage.getItem('mw_shown_milestones') || '[]');

            // Restore visual state
            updateRankDisplay();

            if (gamificationState.wizardActive && gamificationState.wizardUnlocked) {
                document.body.classList.add('wizard-mode');
                const wizToggle = document.getElementById('wizardToggle');
                if (wizToggle) wizToggle.style.display = 'flex';
                const avatar = document.getElementById('wizardAvatar');
                if (avatar) avatar.style.display = 'block';
                spawnParticles();
            }

            if (gamificationState.wizardUnlocked && !gamificationState.wizardActive) {
                const wizToggle = document.getElementById('wizardToggle');
                if (wizToggle) wizToggle.style.display = 'flex';
            }

            if (gamificationState.voiceUnlocked) {
                const voiceToggle = document.getElementById('voiceToggle');
                if (voiceToggle) voiceToggle.style.display = 'flex';
            }

            // Show wizard avatar if past milestone 10
            if (gamificationState.searchCount >= 10) {
                const avatar = document.getElementById('wizardAvatar');
                if (avatar && (gamificationState.wizardActive || gamificationState.searchCount < 30)) {
                    avatar.style.display = 'block';
                }
            }

            // Sparkle effect if past 5 searches
            if (gamificationState.searchCount >= 5) {
                addLogoSparkle();
            }

            // Upgrade logo based on level
            updateLogoLevel();
        }

        function updateLogoLevel(animate) {
            const logoIcon = document.getElementById('logoIcon');
            if (!logoIcon) return;
            const count = gamificationState.searchCount;

            // Remove all level classes
            logoIcon.classList.remove('wizard-revealed', 'archmage-level', 'grand-wizard-level');

            if (count >= 50) {
                logoIcon.classList.add('grand-wizard-level');
            } else if (count >= 30) {
                logoIcon.classList.add('archmage-level');
            } else if (count >= 10) {
                logoIcon.classList.add('wizard-revealed');
            }

            // Animate the transition if requested (on milestone hit)
            if (animate && count >= 10) {
                logoIcon.style.transform = 'scale(0.5) rotate(-20deg)';
                setTimeout(() => {
                    logoIcon.style.transform = 'scale(1.2) rotate(5deg)';
                    setTimeout(() => {
                        logoIcon.style.transform = '';
                    }, 300);
                }, 100);
            }
        }

        function saveGamificationState() {
            localStorage.setItem('mw_search_count', gamificationState.searchCount.toString());
            localStorage.setItem('mw_wizard_unlocked', gamificationState.wizardUnlocked.toString());
            localStorage.setItem('mw_wizard_active', gamificationState.wizardActive.toString());
            localStorage.setItem('mw_voice_unlocked', gamificationState.voiceUnlocked.toString());
            localStorage.setItem('mw_voice_active', gamificationState.voiceActive.toString());
            localStorage.setItem('mw_shown_milestones', JSON.stringify(gamificationState.shownMilestones));
        }

        function incrementSearchCount() {
            gamificationState.searchCount++;
            saveGamificationState();
            updateRankDisplay();
            checkMilestones();

            // Show wizard tip every 5 searches after sage (20+)
            if (gamificationState.searchCount >= 20 && gamificationState.searchCount % 5 === 0) {
                setTimeout(() => showRandomWizardTip(), 2000);
            }
        }

        function checkMilestones() {
            for (const milestone of MILESTONES) {
                if (gamificationState.searchCount >= milestone.count &&
                    !gamificationState.shownMilestones.includes(milestone.count)) {
                    gamificationState.shownMilestones.push(milestone.count);
                    saveGamificationState();
                    setTimeout(() => showMilestone(milestone), 800);
                    break;  // Show one at a time
                }
            }
        }

        function showMilestone(milestone) {
            const overlay = document.getElementById('milestoneOverlay');
            const title = document.getElementById('milestoneTitle');
            const subtitle = document.getElementById('milestoneSubtitle');
            const wizImg = document.getElementById('milestoneWizardImg');
            const levelLabel = document.getElementById('milestoneLevelLabel');
            const xpCurrent = document.getElementById('milestoneXpCurrent');
            const xpNext = document.getElementById('milestoneXpNext');
            const xpFill = document.getElementById('milestoneXpFill');
            const confettiEl = document.getElementById('milestoneConfetti');

            // Set content
            title.textContent = milestone.title;
            subtitle.textContent = milestone.subtitle;

            // Level label
            const milestoneIdx = MILESTONES.findIndex(m => m.count === milestone.count);
            levelLabel.textContent = `LEVEL ${milestoneIdx + 1} ACHIEVED`;

            // XP progress bar
            const nextMilestone = MILESTONES[milestoneIdx + 1];
            xpCurrent.textContent = `${gamificationState.searchCount} searches`;
            xpNext.textContent = nextMilestone ? `Next: ${nextMilestone.count}` : 'MAX LEVEL';
            const prevCount = milestoneIdx > 0 ? MILESTONES[milestoneIdx - 1].count : 0;
            const nextCount = nextMilestone ? nextMilestone.count : milestone.count;
            const pct = nextMilestone
                ? ((gamificationState.searchCount - prevCount) / (nextCount - prevCount)) * 100
                : 100;
            xpFill.style.setProperty('--xp-from', '0%');
            xpFill.style.setProperty('--xp-to', Math.min(pct, 100) + '%');

            // Screen shake
            document.body.classList.add('screen-shake');
            setTimeout(() => document.body.classList.remove('screen-shake'), 500);

            // Golden flash
            const flash = document.getElementById('screenFlash');
            flash.classList.add('active');
            setTimeout(() => flash.classList.remove('active'), 800);

            // Show overlay
            overlay.classList.add('active');

            // Spawn confetti inside the card
            if (confettiEl) {
                confettiEl.innerHTML = '';
                const colors = ['#fbbf24', '#8b5cf6', '#ec4899', '#3b82f6', '#10b981', '#f97316'];
                for (let i = 0; i < 40; i++) {
                    const piece = document.createElement('div');
                    piece.className = 'confetti-piece';
                    piece.style.left = Math.random() * 100 + '%';
                    piece.style.top = '-10px';
                    piece.style.background = colors[Math.floor(Math.random() * colors.length)];
                    piece.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
                    piece.style.width = (4 + Math.random() * 8) + 'px';
                    piece.style.height = (4 + Math.random() * 8) + 'px';
                    piece.style.animationDuration = (1.5 + Math.random() * 2) + 's';
                    piece.style.animationDelay = (Math.random() * 0.8) + 's';
                    confettiEl.appendChild(piece);
                }
            }

            // Play dramatic sound based on milestone tier
            if (milestoneIdx >= 3) {
                playEpicFanfare();
            } else {
                playAchievementSound();
            }
            burstParticles(40 + milestoneIdx * 15);

            // Apply milestone-specific effects
            applyMilestoneEffect(milestone.effect);

            // Upgrade the header logo
            updateLogoLevel(true);
        }

        function dismissMilestone() {
            const overlay = document.getElementById('milestoneOverlay');
            overlay.classList.remove('active');
            const confettiEl = document.getElementById('milestoneConfetti');
            if (confettiEl) setTimeout(() => confettiEl.innerHTML = '', 500);
        }

        function applyMilestoneEffect(effect) {
            switch (effect) {
                case 'sparkle':
                    addLogoSparkle();
                    break;
                case 'wizardReveal':
                    revealWizard();
                    setTimeout(() => playWizardVoice('greeting'), 1200);
                    break;
                case 'sage':
                    const avatar = document.getElementById('wizardAvatar');
                    if (avatar) avatar.style.display = 'block';
                    playWizardVoice('sage');
                    break;
                case 'wizardUnlock':
                    unlockWizardMode();
                    setTimeout(() => playWizardVoice('unlock'), 1000);
                    break;
                case 'grandWizard':
                    burstParticles(60);
                    playWizardVoice('grand');
                    break;
                case 'voiceUnlock':
                    unlockVoiceMode();
                    break;
            }
        }

        function addLogoSparkle() {
            const logo = document.querySelector('.logo');
            if (!logo || logo.querySelector('.logo-sparkle')) return;

            for (let i = 0; i < 3; i++) {
                const sparkle = document.createElement('span');
                sparkle.className = 'logo-sparkle';
                sparkle.style.left = (20 + Math.random() * 60) + '%';
                sparkle.style.top = (10 + Math.random() * 80) + '%';
                sparkle.style.animationDelay = (Math.random() * 2) + 's';
                logo.style.position = 'relative';
                logo.appendChild(sparkle);
            }
        }

        function revealWizard() {
            const avatar = document.getElementById('wizardAvatar');
            if (!avatar) return;

            avatar.style.display = 'block';
            avatar.style.animation = 'wizardFlyIn 1.2s cubic-bezier(0.34, 1.56, 0.64, 1) forwards';
            playSparkleSound();

            // Wizard greeting after fly-in
            setTimeout(() => {
                showWizardSpeech("Greetings! I am the Manager Wizard. I shall assist you on your quest!");
            }, 1500);
        }

        function unlockWizardMode() {
            gamificationState.wizardUnlocked = true;
            saveGamificationState();

            const wizToggle = document.getElementById('wizardToggle');
            if (wizToggle) wizToggle.style.display = 'flex';

            // Auto-activate wizard mode on first unlock
            setTimeout(() => toggleWizardMode(), 1500);
        }

        function unlockVoiceMode() {
            gamificationState.voiceUnlocked = true;
            saveGamificationState();

            const voiceToggle = document.getElementById('voiceToggle');
            if (voiceToggle) voiceToggle.style.display = 'flex';
        }

        function toggleWizardMode() {
            if (!gamificationState.wizardUnlocked) return;

            gamificationState.wizardActive = !gamificationState.wizardActive;
            saveGamificationState();

            const body = document.body;
            const btn = document.getElementById('wizardToggle');
            const avatar = document.getElementById('wizardAvatar');

            if (gamificationState.wizardActive) {
                body.classList.add('wizard-mode');
                if (btn) btn.innerHTML = '<i class="fas fa-building"></i> Corporate Mode';
                if (avatar) avatar.style.display = 'block';
                spawnParticles();
                playWizardOnSound();
                playWizardVoice('modeOn');
                showWizardSpeech("The arcane realm reveals itself!");
            } else {
                body.classList.remove('wizard-mode');
                if (btn) btn.innerHTML = '<i class="fas fa-hat-wizard"></i> Wizard Mode';
                if (avatar) avatar.style.display = 'none';
                clearParticles();
                playWizardOffSound();
                playWizardVoice('modeOff');
            }
        }

        function toggleVoiceMode() {
            if (!gamificationState.voiceUnlocked) return;

            gamificationState.voiceActive = !gamificationState.voiceActive;
            saveGamificationState();

            const btn = document.getElementById('voiceToggle');
            if (gamificationState.voiceActive) {
                if (btn) btn.innerHTML = '<i class="fas fa-volume-mute"></i> Voice Off';
                showWizardSpeech("Voice Mode activated! I shall narrate your journey!");
            } else {
                if (btn) btn.innerHTML = '<i class="fas fa-volume-up"></i> Voice Mode';
            }
        }

        function updateRankDisplay() {
            const rankDisplay = document.getElementById('rankDisplay');
            if (!rankDisplay) return;

            let currentRank = null;
            for (const m of MILESTONES) {
                if (gamificationState.searchCount >= m.count) currentRank = m;
            }

            if (currentRank) {
                rankDisplay.style.display = 'flex';
                rankDisplay.innerHTML = `<i class="fas ${currentRank.icon}"></i> ${currentRank.title}`;
            } else {
                rankDisplay.style.display = 'none';
            }
        }

        // ---- Wizard Speech Bubble ----

        function showWizardSpeech(text) {
            const bubble = document.getElementById('wizardSpeech');
            const avatar = document.getElementById('wizardAvatar');
            if (!bubble || !avatar) return;

            if (avatar.style.display === 'none') return;

            bubble.textContent = text;
            bubble.style.display = 'block';
            bubble.style.animation = 'bubbleIn 0.3s ease forwards';

            setTimeout(() => {
                bubble.style.display = 'none';
            }, 5000);
        }

        function showRandomWizardTip() {
            const tip = WIZARD_TIPS[Math.floor(Math.random() * WIZARD_TIPS.length)];
            showWizardSpeech(tip);
        }

        // ---- Particle System ----

        function spawnParticles() {
            const container = document.getElementById('particlesContainer');
            if (!container) return;
            clearParticles();

            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + 'vw';
                particle.style.top = Math.random() * 100 + 'vh';
                particle.style.width = (3 + Math.random() * 5) + 'px';
                particle.style.height = particle.style.width;
                particle.style.animationDuration = (4 + Math.random() * 6) + 's';
                particle.style.animationDelay = Math.random() * 5 + 's';
                container.appendChild(particle);
            }
        }

        function clearParticles() {
            const container = document.getElementById('particlesContainer');
            if (container) container.innerHTML = '';
        }

        function burstParticles(count) {
            const container = document.getElementById('particlesContainer');
            if (!container) return;

            for (let i = 0; i < (count || 20); i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                const angle = (Math.PI * 2 * i) / count;
                const distance = 100 + Math.random() * 200;
                const startX = window.innerWidth / 2;
                const startY = window.innerHeight / 2;

                particle.style.left = startX + 'px';
                particle.style.top = startY + 'px';
                particle.style.width = (4 + Math.random() * 6) + 'px';
                particle.style.height = particle.style.width;
                particle.style.background = `hsl(${Math.random() * 60 + 30}, 100%, 60%)`;
                particle.style.position = 'fixed';
                particle.style.borderRadius = '50%';
                particle.style.zIndex = '100000';
                particle.style.transition = 'all 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                particle.style.opacity = '1';

                container.appendChild(particle);

                requestAnimationFrame(() => {
                    particle.style.left = (startX + Math.cos(angle) * distance) + 'px';
                    particle.style.top = (startY + Math.sin(angle) * distance) + 'px';
                    particle.style.opacity = '0';
                    particle.style.transform = 'scale(0)';
                });

                setTimeout(() => particle.remove(), 1500);
            }
        }

        // ---- Sound System (Web Audio API) ----

        let audioCtx = null;
        function getAudioCtx() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            return audioCtx;
        }

        function playNote(freq, duration, type, gain) {
            try {
                const ctx = getAudioCtx();
                const osc = ctx.createOscillator();
                const g = ctx.createGain();
                osc.type = type || 'sine';
                osc.frequency.setValueAtTime(freq, ctx.currentTime);
                g.gain.setValueAtTime(gain || 0.15, ctx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration);
                osc.connect(g);
                g.connect(ctx.destination);
                osc.start();
                osc.stop(ctx.currentTime + duration);
            } catch (e) { /* Audio not available */ }
        }

        function playAchievementSound() {
            // Dramatic rising fanfare with harmony
            const notes = [
                { freq: 392, delay: 0, dur: 0.3, type: 'triangle', gain: 0.12 },    // G4
                { freq: 523, delay: 0.12, dur: 0.3, type: 'triangle', gain: 0.12 },  // C5
                { freq: 659, delay: 0.24, dur: 0.3, type: 'triangle', gain: 0.13 },  // E5
                { freq: 784, delay: 0.36, dur: 0.5, type: 'triangle', gain: 0.14 },  // G5
                { freq: 1047, delay: 0.50, dur: 0.8, type: 'sine', gain: 0.15 },     // C6 (high)
                // Harmony layer
                { freq: 262, delay: 0, dur: 1.2, type: 'sine', gain: 0.06 },         // C4 bass
                { freq: 330, delay: 0.12, dur: 1.0, type: 'sine', gain: 0.05 },      // E4
                { freq: 523, delay: 0.50, dur: 0.9, type: 'sine', gain: 0.08 },      // C5 sustained
            ];
            notes.forEach(n => setTimeout(() => playNote(n.freq, n.dur, n.type, n.gain), n.delay * 1000));
        }

        function playEpicFanfare() {
            // EPIC fanfare for major milestones (Archmage+)
            const notes = [
                // Opening power chord
                { freq: 196, delay: 0, dur: 0.4, type: 'sawtooth', gain: 0.08 },     // G3
                { freq: 262, delay: 0, dur: 0.4, type: 'triangle', gain: 0.10 },     // C4
                // Rising arpeggio
                { freq: 330, delay: 0.15, dur: 0.25, type: 'triangle', gain: 0.10 },
                { freq: 392, delay: 0.25, dur: 0.25, type: 'triangle', gain: 0.11 },
                { freq: 523, delay: 0.35, dur: 0.3, type: 'triangle', gain: 0.12 },
                { freq: 659, delay: 0.45, dur: 0.3, type: 'triangle', gain: 0.13 },
                { freq: 784, delay: 0.55, dur: 0.4, type: 'sine', gain: 0.14 },
                // BOOM - big sustained chord
                { freq: 1047, delay: 0.70, dur: 1.5, type: 'sine', gain: 0.15 },     // C6
                { freq: 784, delay: 0.70, dur: 1.5, type: 'sine', gain: 0.10 },      // G5
                { freq: 523, delay: 0.70, dur: 1.5, type: 'triangle', gain: 0.08 },  // C5
                { freq: 262, delay: 0.70, dur: 1.5, type: 'triangle', gain: 0.06 },  // C4 bass
                // Sparkle tail
                { freq: 1319, delay: 1.0, dur: 0.5, type: 'sine', gain: 0.06 },
                { freq: 1568, delay: 1.1, dur: 0.4, type: 'sine', gain: 0.05 },
                { freq: 2093, delay: 1.2, dur: 0.6, type: 'sine', gain: 0.04 },
            ];
            notes.forEach(n => setTimeout(() => playNote(n.freq, n.dur, n.type, n.gain), n.delay * 1000));
        }

        function playSparkleSound() {
            [0, 0.06, 0.12, 0.18].forEach((delay, i) => {
                setTimeout(() => playNote([1200, 1500, 1800, 2200][i], 0.3, 'sine', 0.07), delay * 1000);
            });
        }

        function playWizardOnSound() {
            // Ascending magical chord with sweep
            const notes = [
                { freq: 262, delay: 0, dur: 1.0, type: 'sine', gain: 0.06 },
                { freq: 392, delay: 0.08, dur: 0.8, type: 'triangle', gain: 0.10 },
                { freq: 523, delay: 0.16, dur: 0.8, type: 'triangle', gain: 0.10 },
                { freq: 659, delay: 0.24, dur: 0.8, type: 'sine', gain: 0.10 },
                { freq: 784, delay: 0.32, dur: 1.0, type: 'sine', gain: 0.12 },
                { freq: 1047, delay: 0.40, dur: 0.8, type: 'sine', gain: 0.08 },
            ];
            notes.forEach(n => setTimeout(() => playNote(n.freq, n.dur, n.type, n.gain), n.delay * 1000));
        }

        function playWizardOffSound() {
            [0, 0.1, 0.2, 0.3].forEach((delay, i) => {
                setTimeout(() => playNote([784, 659, 523, 392][i], 0.5, 'triangle', 0.08), delay * 1000);
            });
        }

        function playPortalSound() {
            try {
                const ctx = getAudioCtx();
                const osc = ctx.createOscillator();
                const g = ctx.createGain();
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(200, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(800, ctx.currentTime + 0.5);
                osc.frequency.exponentialRampToValueAtTime(200, ctx.currentTime + 1.0);
                g.gain.setValueAtTime(0.08, ctx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 1.0);
                osc.connect(g); g.connect(ctx.destination);
                osc.start(); osc.stop(ctx.currentTime + 1.0);
            } catch (e) {}
        }

        // ---- Easter Eggs ----

        function checkEasterEggs(query) {
            const q = query.toLowerCase().trim();
            if (EASTER_EGG_SEARCHES[q]) {
                triggerEasterEgg(EASTER_EGG_SEARCHES[q]);
                return true;
            }
            return false;
        }

        function triggerEasterEgg(effect) {
            switch (effect) {
                case 'particleBurst':
                    burstParticles(50);
                    playPortalSound();
                    showWizardSpeech(" The ancient magic surges!");
                    break;
                case 'wizardOn':
                    if (gamificationState.wizardUnlocked && !gamificationState.wizardActive) {
                        toggleWizardMode();
                    } else if (!gamificationState.wizardUnlocked) {
                        showWizardSpeech("The spell fizzles... you haven't unlocked this power yet!");
                        playSparkleSound();
                    }
                    break;
                case 'wizardOff':
                    if (gamificationState.wizardActive) {
                        toggleWizardMode();
                    }
                    break;
                case 'patronus':
                    burstParticles(80);
                    playAchievementSound();
                    const avatar = document.getElementById('wizardAvatar');
                    if (avatar) {
                        avatar.style.display = 'block';
                        avatar.style.animation = 'glowPulse 1s ease 3';
                    }
                    break;
                case 'portalOpen':
                    playPortalSound();
                    burstParticles(40);
                    document.body.style.transition = 'filter 0.5s';
                    document.body.style.filter = 'hue-rotate(180deg)';
                    setTimeout(() => {
                        document.body.style.filter = '';
                    }, 2000);
                    break;
            }
        }

        // ---- Dev Helpers (console only) ----

        window.resetWizard = function() {
            localStorage.removeItem('mw_search_count');
            localStorage.removeItem('mw_wizard_unlocked');
            localStorage.removeItem('mw_wizard_active');
            localStorage.removeItem('mw_voice_unlocked');
            localStorage.removeItem('mw_voice_active');
            localStorage.removeItem('mw_shown_milestones');
            location.reload();
        };

        window.fastForwardTo = function(n) {
            gamificationState.searchCount = n - 1;
            gamificationState.shownMilestones = MILESTONES
                .filter(m => m.count < n)
                .map(m => m.count);
            saveGamificationState();
            incrementSearchCount();
        };

        window.getWizardState = function() {
            return { ...gamificationState };
        };
    </script>
    <!-- Wizard Avatar (appears after 10 searches) -->
    <div class="wizard-avatar-container" id="wizardAvatar">
        <div class="wizard-speech-bubble" id="wizardSpeech"></div>
        <img src="https://storage.googleapis.com/pspm-community-images/wizard/wizard-character.png" alt="Manager Wizard" onclick="showRandomWizardTip()">
    </div>

    <!-- Screen Flash Effect -->
    <div class="screen-flash" id="screenFlash"></div>

    <!-- Milestone Celebration Overlay - DRAMATIC -->
    <div class="milestone-overlay" id="milestoneOverlay" onclick="if(event.target===this)dismissMilestone()">
        <div class="milestone-card" id="milestoneCard">
            <div class="milestone-confetti" id="milestoneConfetti"></div>
            <img class="milestone-wizard-img" id="milestoneWizardImg"
                 src="https://storage.googleapis.com/pspm-community-images/wizard/wizard-character.png"
                 alt="Manager Wizard">
            <div class="milestone-level-label" id="milestoneLevelLabel">ACHIEVEMENT UNLOCKED</div>
            <img class="milestone-badge-img" id="milestoneBadgeImg"
                 src="https://storage.googleapis.com/pspm-community-images/wizard/wizard-badges.png"
                 alt="Badge" style="display:none">
            <div class="milestone-title" id="milestoneTitle"></div>
            <div class="milestone-subtitle" id="milestoneSubtitle"></div>
            <div class="milestone-xp-section">
                <div class="milestone-xp-label">
                    <span id="milestoneXpCurrent">0 searches</span>
                    <span id="milestoneXpNext">Next: 10</span>
                </div>
                <div class="milestone-xp-bar">
                    <div class="milestone-xp-fill" id="milestoneXpFill"></div>
                </div>
            </div>
            <button class="milestone-dismiss" onclick="dismissMilestone()">Continue Your Quest</button>
        </div>
    </div>

    <!-- Floating Particles (wizard mode) -->
    <div class="particles-container" id="particlesContainer"></div>
</body>
</html>
